---
title: World Bank data viz
layout: default
output: bookdown::html_chapter
---

<!-- paragraph -->

# Chapter 8, World Bank data viz

<!-- paragraph -->

```{r setup, echo=FALSE}
knitr::opts_chunk$set(fig.path="Ch08-figures/")
```

<!-- paragraph -->

In this chapter we will explore several data visualizations of the World Bank data set.

<!-- paragraph -->

Chapter outline:

<!-- paragraph -->

- We begin by loading the World Bank data set and defining some helper functions for creating a multi-panel ggplot with several geoms.
<!-- comment -->
- We then create a time series plot for life expectancy.
<!-- comment -->
- We then add a scatterplot of life expectancy versus fertility rate as a second panel.
<!-- comment -->
- We then add a third panel with a time series for fertility rate.

<!-- paragraph -->

## Load data and define helper functions {#load}

<!-- paragraph -->

First we load the WorldBank data set, and consider only the subset which has both non-missing values for both life.expectancy and fertility.rate.

<!-- paragraph -->

```{r}
library(animint2)
data(WorldBank)
WorldBank$Region <- sub(" (all income levels)", "", WorldBank$region, fixed=TRUE)
library(data.table)
not.na <- data.table(
  WorldBank)[!(is.na(life.expectancy) | is.na(fertility.rate))]
<!-- comment -->
```

<!-- paragraph -->

We will also be plotting the population variable using a size legend.
<!-- comment -->
Before plotting, we will make sure that none of the values are missing.

<!-- paragraph -->

```{r}
not.na[is.na(not.na$population)]
<!-- comment -->
```

<!-- paragraph -->

The table above shows that there are three rows with missing values for the population variable.
<!-- comment -->
They are for the country Kuwait during 1992-1994.
<!-- comment -->
The table below shows the data from the neighboring years, 1991-1995.

<!-- paragraph -->

```{r}
not.na[country == "Kuwait" & 1991 <= year & year <= 1995]
<!-- comment -->
```

<!-- paragraph -->

The table above shows that the population of Kuwait decreased over the period 1991-1995, consistent with the Gulf War of that time period.
<!-- comment -->
We fill in those missing values below.

<!-- paragraph -->

```{r}
not.na[is.na(population), population := 1700000]
<!-- comment -->
not.na[country == "Kuwait" & 1991 <= year & year <= 1995]
<!-- comment -->
```

<!-- paragraph -->

Next, we define the following helper function, which will be used to add columns to data sets in order to assign geoms to facets.

<!-- paragraph -->

```{r}
FACETS <- function(df, top, side){
  data.frame(df,
             top=factor(top, c("Fertility rate", "Years")),
             side=factor(side, c("Years", "Life expectancy")))
}
```

<!-- paragraph -->

Note that the factor levels will specify the order of the facets in the ggplot.
<!-- comment -->
This is an example of the [addColumn then facet idiom](Ch99-appendix.html#addColumn-then-facet) .
<!-- comment -->
Below, we define three helper functions, one for each facet.

<!-- paragraph -->

```{r}
TS.RIGHT <- function(df)FACETS(df, "Years", "Life expectancy")
SCATTER <- function(df)FACETS(df, "Fertility rate", "Life expectancy")
TS.ABOVE <- function(df)FACETS(df, "Fertility rate", "Years")
```

<!-- paragraph -->

## First time series plot {#first-ts}

<!-- paragraph -->

First we define a data set with one row for each year, which we will use for selecting years using a `geom_tallrect` in the background.

<!-- paragraph -->

```{r}
years <- unique(not.na[, .(year)])
```

<!-- paragraph -->

We define the ggplot with a `geom_tallrect` in the background, and a `geom_line` for the time series.

<!-- paragraph -->

```{r}
ts.right <- ggplot()+
  geom_tallrect(aes(
    xmin=year-1/2, xmax=year+1/2),
    clickSelects="year",
    data=TS.RIGHT(years), alpha=1/2)+
  geom_line(aes(
    year, life.expectancy, group=country, colour=Region),
    clickSelects="country",
    data=TS.RIGHT(not.na), size=4, alpha=3/5)
ts.right
```

<!-- paragraph -->

Note that we specified `clickSelects=year` so that clicking a tallrect will change the selected year, and `clickSelects=country` so that clicking a line will select or de-select a country.
<!-- comment -->
Also note that we used `TS.RIGHT` to specify columns that we will use in the facet specification (next section).

<!-- paragraph -->

## Add a scatterplot facet {#add-scatter}

<!-- paragraph -->

We begin by simply adding facets to the previous time series plot.

<!-- paragraph -->

```{r}
ts.facet <- ts.right+
  theme_bw()+
  theme(panel.margin=grid::unit(0, "lines"))+
  facet_grid(side ~ top, scales="free")+
  xlab("")+
  ylab("")
ts.facet
```

<!-- paragraph -->

We set the `panel.margin` to 0, which is always a good idea to [save space in a ggplot with facets](Ch99-appendix.html#space-saving-facets) .
<!-- comment -->
We use `scales="free"` and hide the axis labels, in an example of the [addColumn then facet idiom](Ch99-appendix.html#addColumn-then-facet) .
<!-- comment -->
Instead, we use the facet label to show the variable encoded on each axis.
<!-- comment -->
Below, we add a scatterplot facet with a point for each year and country.

<!-- paragraph -->

```{r}
ts.scatter <- ts.facet+
  theme_animint(width=600)+
  geom_point(aes(
    fertility.rate, life.expectancy,
    colour=Region, size=population,
    key=country), # key aesthetic for animated transitions!
<!-- comment -->
clickSelects="country",
    showSelected="year",
    data=SCATTER(not.na))+
  scale_size_animint(pixel.range=c(2, 20), breaks=10^(9:5))
ts.scatter
```

<!-- paragraph -->

Note how we use `scale_size_animint` to specify the range of sizes in pixels, and the breaks in the legend.
<!-- comment -->
Also note that we use `SCATTER` to specify `top` and `side` columns which are used in the facet specification.
<!-- comment -->
We also render this ggplot interactively below.

<!-- paragraph -->

```{r Ch08-viz-ts-scatter}
animint(ts.scatter)
```

<!-- paragraph -->

Note that single selection is used by default for both year and country.

<!-- paragraph -->

## Adding another time series facet {#add-ts}

<!-- paragraph -->

Below we add widerects for selecting years, and paths for showing fertility rate.

<!-- paragraph -->

```{r}
scatter.both <- ts.scatter+
  geom_widerect(aes(
    ymin=year-1/2, ymax=year+1/2),
    clickSelects="year",
    data=TS.ABOVE(years), alpha=1/2)+
  geom_path(aes(
    fertility.rate, year, group=country, colour=Region),
    clickSelects="country",
    data=TS.ABOVE(not.na), size=4, alpha=3/5)
scatter.both
```

<!-- paragraph -->

Note that `TS.ABOVE` was used to specify facet columns `top` and `side`.
<!-- comment -->
We render an interactive version below.

<!-- paragraph -->

```{r Ch08-viz-scatter-both}
viz.scatter.both <- animint(
  title="World Bank data (multiple selection, facets)",
  scatterBoth=scatter.both+
    theme_animint(width=1000, height=800),
  duration=list(year=1000),
  time=list(variable="year", ms=3000),
  first=list(year=1975, country=c("United States", "Vietnam")),
  selector.types=list(country="multiple"))
```

<!-- paragraph -->

## Chapter summary and exercises {#exercises}

<!-- paragraph -->

We showed how to create a multi-layer, multi-panel (but single-plot) visualization of the World Bank data.

<!-- paragraph -->

Exercises:

<!-- paragraph -->

- Add a points on each time series plot, with size proportional to population as in the scatterplot.
<!-- comment -->
The points should appear only when the country is selected, and clicking the points should de-select that country.
<!-- comment -->
- Add text labels to the time series plot on the right, with names for each country.
<!-- comment -->
Each label should appear only when the country is selected, and should disappear after clicking on the label.
<!-- comment -->
- Add a text label to the scatterplot to indicate the selected year.
<!-- comment -->
- Add text labels to the scatterplot, with names for each country.
<!-- comment -->
Each label should appear only when the country is selected, and should disappear after clicking on the label.

<!-- paragraph -->

Next, [Chapter 9](Ch09-Montreal-bikes.html) explains how to visualize the Montreal bike data set.

<!-- paragraph -->



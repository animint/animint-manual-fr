---
title: Visualisation des données de la Banque mondiale viz
layout: default
output: bookdown::html_chapter
---



Traduction de l'[anglais](https://github.com/tdhock/animint-book/)
[Ch08-WorldBank-facets](https://raw.githubusercontent.com/tdhock/animint-book/master/Ch08-WorldBank-facets.Rmd)


<!-- paragraph -->

# Chapitre 8, visualisation des données de la Banque mondiale viz

<!-- paragraph -->

```{r setup, echo=FALSE}
knitr::opts_chunk$set(fig.path="Ch08-figures/")
```

<!-- paragraph -->

Dans ce chapitre, nous allons explorer plusieurs visualisations des données de la Banque mondiale.

<!-- paragraph -->

Plan du chapitre :

<!-- paragraph -->

- Nous commençons par charger le jeu de données de la Banque mondiale et par définir quelques fonctions d'aide pour créer un ggplot multi-panneaux avec plusieurs geoms.
<!-- comment -->
- Nous créons ensuite un graphique de série chronologique pour l'espérance de vie.
<!-- comment -->
- Nous ajoutons ensuite un nuage de points de l'espérance de vie en fonction du taux de fécondité dans un deuxième panneau.
<!-- comment -->
- Nous ajoutons ensuite un troisième panneau avec une série temporelle pour le taux de fécondité.

<!-- paragraph -->

## Chargement des données et définition des fonctions d'aide {#load}

<!-- paragraph -->

Tout d'abord, nous chargeons l'ensemble des données de la Banque mondiale, et nous ne considérons que le sous-ensemble qui a des valeurs non manquantes à la fois pour l'espérance de vie et le taux de fécondité.

<!-- paragraph -->

```{r}
library(animint2)
data(WorldBank)
WorldBank$Region <- sub(" (all income levels)", "", WorldBank$region, fixed=TRUE)
library(data.table)
not.na <- data.table(
  WorldBank)[!(is.na(life.expectancy) | is.na(fertility.rate))]
<!-- comment -->
```

<!-- paragraph -->

Nous allons également tracer la variable population à l'aide d'une légende de taille.
<!-- comment -->
Avant de tracer le graphique, nous nous assurerons qu'aucune valeur n'est manquante.

<!-- paragraph -->

```{r}
not.na[is.na(not.na$population)]
<!-- comment -->
```

<!-- paragraph -->

Le tableau de contingence ci-dessus montre qu'il y a trois lignes avec des valeurs manquantes pour la variable population.
<!-- comment -->
Elles concernent le pays Koweït pour la période 1992-1994.
<!-- comment -->
Le tableau de contingence ci-dessous reprend les données des années voisines, 1991-1995.

<!-- paragraph -->

```{r}
not.na[country == "Kuwait" & 1991 <= year & year <= 1995]
<!-- comment -->
```

<!-- paragraph -->

Le tableau de contingence ci-dessus montre que la population du Koweït a diminué au cours de la période 1991-1995, ce qui correspond à la guerre du Golfe de cette période.
<!-- comment -->
Nous remplissons les valeurs manquantes ci-dessous.

<!-- paragraph -->

```{r}
not.na[is.na(population), population := 1700000]
<!-- comment -->
not.na[country == "Kuwait" & 1991 <= year & year <= 1995]
<!-- comment -->
```

<!-- paragraph -->

Ensuite, nous définissons la fonction d'aide suivante, qui sera utilisée pour ajouter des colonnes aux ensembles de données afin d'affecter des geoms aux facettes.

<!-- paragraph -->

```{r}
FACETS <- function(df, top, side){
  data.frame(df,
             top=factor(top, c("Fertility rate", "Years")),
             side=factor(side, c("Years", "Life expectancy")))
}
```

<!-- paragraph -->

Notez que les niveaux des facteurs spécifieront l'ordre des facettes dans le ggplot.
<!-- comment -->
Il s'agit d'un exemple de la méthode [addColumn then facet idiom](Ch99-appendix.html#addColumn-then-facet) .
<!-- comment -->
Nous définissons ci-dessous trois fonctions d'aide, une pour chaque facette.

<!-- paragraph -->

```{r}
TS.RIGHT <- function(df)FACETS(df, "Years", "Life expectancy")
SCATTER <- function(df)FACETS(df, "Fertility rate", "Life expectancy")
TS.ABOVE <- function(df)FACETS(df, "Fertility rate", "Years")
```

<!-- paragraph -->

## Premier graphique de la série temporelle {#first-ts}

<!-- paragraph -->

Nous définissons d'abord un ensemble de données avec une ligne pour chaque année, que nous utiliserons pour sélectionner les années à l'aide d'une fonction `geom_tallrect` en arrière-plan.

<!-- paragraph -->

```{r}
years <- unique(not.na[, .(year)])
```

<!-- paragraph -->

Nous définissons le ggplot avec un `geom_tallrect` en arrière-plan, et un `geom_line` pour les séries temporelles.

<!-- paragraph -->

```{r}
ts.right <- ggplot()+
  geom_tallrect(aes(
    xmin=year-1/2, xmax=year+1/2),
    clickSelects="year",
    data=TS.RIGHT(years), alpha=1/2)+
  geom_line(aes(
    year, life.expectancy, group=country, colour=Region),
    clickSelects="country",
    data=TS.RIGHT(not.na), size=4, alpha=3/5)
ts.right
```

<!-- paragraph -->

Notez que nous avons spécifié `clickSelects=year` pour que le fait de cliquer sur un tallrect modifie l'année sélectionnée, et `clickSelects=country` pour que le fait de cliquer sur une ligne permette de sélectionner ou de désélectionner un pays.
<!-- comment -->
Notez également que nous avons utilisé `TS.RIGHT` pour spécifier les colonnes que nous utiliserons dans la spécification des facettes (section suivante).

<!-- paragraph -->

## Ajouter une facette de nuage de points {#add-scatter}

<!-- paragraph -->

Nous commençons par ajouter simplement des facettes au graphique de la série temporelle précédente.

<!-- paragraph -->

```{r}
ts.facet <- ts.right+
  theme_bw()+
  theme(panel.margin=grid::unit(0, "lines"))+
  facet_grid(side ~ top, scales="free")+
  xlab("")+
  ylab("")
ts.facet
```

<!-- paragraph -->

Nous définissons l'élément `panel.margin` à 0, ce qui est toujours une bonne idée pour [d'économiser de l'espace dans un ggplot à facettes](Ch99-appendix.html#space-saving-facets) .
<!-- comment -->
Nous utilisons `scales="free"` et masquons les étiquettes des axes, dans un exemple de la méthode [addColumn then facet idiom](Ch99-appendix.html#addColumn-then-facet) .
<!-- comment -->
Au lieu de cela, nous utilisons l'étiquette de la facette pour montrer la variable encodée sur chaque axe.
<!-- comment -->
Ci-dessous, nous ajoutons une facette de nuage de points avec un point pour chaque année et chaque pays.

<!-- paragraph -->

```{r}
ts.scatter <- ts.facet+
  theme_animint(width=600)+
  geom_point(aes(
    fertility.rate, life.expectancy,
    colour=Region, size=population,
    key=country), # key aesthetic for animated transitions!
<!-- comment -->
clickSelects="country",
    showSelected="year",
    data=SCATTER(not.na))+
  scale_size_animint(pixel.range=c(2, 20), breaks=10^(9:5))
ts.scatter
```

<!-- paragraph -->

Notez que nous utilisons `scale_size_animint` pour spécifier la plage des tailles en pixels, et les bornes des classes (histogrammes).
<!-- comment -->
Notez également que nous utilisons `SCATTER` pour spécifier `top` et `side` qui sont utilisées dans la spécification de la facette.
<!-- comment -->
Nous affichons également ce ggplot de manière interactive ci-dessous.

<!-- paragraph -->

```{r Ch08-viz-ts-scatter}
animint(ts.scatter)
```

<!-- paragraph -->

Notez que la sélection unique est utilisée par défaut pour l'année et le pays.

<!-- paragraph -->

## Ajout d'une autre facette pour les séries temporelles {#add-ts}

<!-- paragraph -->

Ci-dessous, nous ajoutons des widerects pour sélectionner les années, et des chemins d'accès pour afficher le taux de fécondité.

<!-- paragraph -->

```{r}
scatter.both <- ts.scatter+
  geom_widerect(aes(
    ymin=year-1/2, ymax=year+1/2),
    clickSelects="year",
    data=TS.ABOVE(years), alpha=1/2)+
  geom_path(aes(
    fertility.rate, year, group=country, colour=Region),
    clickSelects="country",
    data=TS.ABOVE(not.na), size=4, alpha=3/5)
scatter.both
```

<!-- paragraph -->

Notez que `TS.ABOVE` a été utilisé pour spécifier les colonnes des facettes `top` et `side`.
<!-- comment -->
Nous affichons une version interactive ci-dessous.

<!-- paragraph -->

```{r Ch08-viz-scatter-both}
viz.scatter.both <- animint(
  title="World Bank data (multiple selection, facets)",
  scatterBoth=scatter.both+
    theme_animint(width=1000, height=800),
  duration=list(year=1000),
  time=list(variable="year", ms=3000),
  first=list(year=1975, country=c("United States", "Vietnam")),
  selector.types=list(country="multiple"))
```

<!-- paragraph -->

## Résumé du chapitre et exercices {#exercises}

<!-- paragraph -->

Nous avons montré comment créer une visualisation multicouche et multi-panneaux (mais à un seul graphique) des données de la Banque mondiale.

<!-- paragraph -->

Exercices :

<!-- paragraph -->

- Ajoutez un point sur chaque graphique de série temporelle, dont la taille est proportionnelle à la population, comme dans le nuage de points.
<!-- comment -->
Les points ne doivent apparaître que lorsque le pays est sélectionné, et un clic sur les points doit désélectionner ce pays.
<!-- comment -->
- Ajoutez des étiquettes de texte au graphique de la série temporelle sur la droite, avec des noms pour chaque pays.
<!-- comment -->
Chaque étiquette ne doit apparaître que lorsque le pays est sélectionné, et doit disparaître après avoir cliqué sur l'étiquette.
<!-- comment -->
- Ajouter une étiquette de texte au nuage de points pour indiquer l'année sélectionnée.
<!-- comment -->
- Ajouter des étiquettes de texte au nuage de points, avec des noms pour chaque pays.
<!-- comment -->
Chaque étiquette ne doit apparaître que lorsque le pays est sélectionné, et doit disparaître après avoir cliqué sur l'étiquette.

<!-- paragraph -->

Suivant, [Chapitre 9](Ch09-Montreal-bikes.html) explique comment visualiser les données sur les vélos à Montréal.

<!-- paragraph -->



---
title: Limitations
layout: default
output: bookdown::html_chapter
---


Traduction de l'[anglais](https://github.com/tdhock/animint-book/)
[Ch07-limitations](https://raw.githubusercontent.com/tdhock/animint-book/master/Ch07-limitations.Rmd)

<!-- paragraph -->

# Chapitre 7, Limites de animint2 et solutions de contournement

<!-- paragraph -->

```{r}
#| echo: false
knitr::opts_chunk$set(fig.path="Ch07-figures/")
```

<!-- paragraph -->

Ce chapitre explique plusieurs limites connues d'animint2 pour certaines tâches de visualisation de données interactives.
<!-- comment -->
Il explique également quelques solutions de contournement que vous pouvez utiliser dans ces situations.
<!-- comment -->
Après avoir lu ce chapitre, vous saurez comment

<!-- paragraph -->

- Utiliser une variable normalisée lorsqu'elle est différente `showSelected` sous-ensembles ont des valeurs très différentes d'une variable que vous souhaitez afficher.
<!-- comment -->
- Calculer les statistiques pour chaque `showSelected` sous-ensemble, plutôt que de s'appuyer sur le sous-ensemble de la base de données. `stat_*` des fonctions `ggplot2`.
<!-- comment -->
- Ajouter des données une par une à un ensemble de variables à sélection multiple, plutôt que d'utiliser un pinceau de sélection rectangulaire.
<!-- comment -->
- Évitez d'utiliser `vjust` et les étiquettes comportant plusieurs lignes dans `geom_text`.
<!-- comment -->
- Ordonner les graphiques sur la page.
<!-- comment -->
- Évitez d'utiliser des éléments non pris en charge. `theme` non supportées.
<!-- comment -->
- Utiliser des facettes avec plusieurs variables par axe.
<!-- comment -->
- Utiliser les facettes `shiny` package serveur web pour modifier de manière interactive la cartographie esthétique d'un animint, ou pour effectuer des calculs basés sur des valeurs sélectionnées.

<!-- paragraph -->

Si vous avez une idée pour améliorer animint2 afin qu'il surmonte l'une de ces limitations, les développeurs d'animint2 seraient plus qu'heureux d'accepter votre [Pull Request](https://github.com/tdhock/animint2/compare) .

<!-- paragraph -->

## Utiliser des variables normalisées pour travailler avec des échelles standardisées {#normalized-variables}

<!-- paragraph -->

Nous implémentons les axes et les légendes de la même manière que ggplot2, en les calculant une fois lorsque le graphique est affiché pour la première fois.
<!-- comment -->
Par conséquent, les axes et les légendes de chaque graphique animint ne sont pas interactifs.
<!-- comment -->
Pour la plupart des [visualisations de données animées](Ch03-showSelected.html#animation-time) les axes fixes permettent de comprendre facilement comment les données changent en même temps que l'image. `time` variable.

<!-- paragraph -->

Dans certaines situations, il serait utile d'avoir des axes qui se mettent à jour de manière interactive.
<!-- comment -->
Un exemple est lorsque différents sous-ensembles showSelected ont des valeurs très différentes pour les variables qui sont affichées avec un axe ou une légende.
<!-- comment -->
Dans ce cas, il serait utile d'avoir des axes interactifs qui se mettent à jour et changent en même temps que les données.
<!-- comment -->
Nous disposons d'une prise en charge expérimentale pour cela, voir [la mise à jour axestest](https://github.com/tdhock/animint2/blob/master/tests/testthat/test-renderer4-update-axes-multiple-ss.R) pour plus de détails.

<!-- paragraph -->

## Calcul des statistiques pour chaque sous-ensemble showSeleted (ou réalisation d'un sous-ensemble). {#stats}

<!-- paragraph -->

Animint ne prend pas en charge les statistiques ggplot2 avec `showSelected`.
<!-- comment -->
Par exemple, considérons le ggplot à facettes ci-dessous.

<!-- paragraph -->

```{r}
set.seed(1)
library(data.table)
random.counts <- data.table(
  letter = c(replicate(4, LETTERS[1:5])),
  count = c(replicate(4, rbinom(5, 50, 0.5))),
  stack = rep(rep(1:2, each = 5), 2),
  facet = rep(1:2, each = 10))
library(animint2)
ggstat <- ggplot() +
  theme_bw()+
  theme(panel.margin=grid::unit(0, "lines"))+
  geom_bar(
      aes(letter, count, fill = stack),
      showSelected="facet",
    data = random.counts,
    stat = "identity",
    position="stack"
  )
ggstat+facet_grid(facet ~ .)
```

<!-- paragraph -->

En utilisant `showSelected` au lieu de facettes ne donne pas le résultat escompté.

<!-- paragraph -->

```{r Ch07-viz-stat}
animint(
  plot = ggstat,
  time = list(variable = "facet", ms = 1000),
  duration = list(facet = 1000))
```

<!-- paragraph -->

Une solution de contournement consiste à calculer ce que vous voulez afficher et à utiliser position=identité.

<!-- paragraph -->

```{r}
random.cumsums <- random.counts[, list(
  cumsum=cumsum(count),
  count=count,
  stack=stack),
  by=.(letter, facet)]
ggidentity <- ggplot() +
  theme_bw()+
  theme(panel.margin=grid::unit(0, "lines"))+
  geom_segment(aes(
    x=letter, xend=letter,
    y=cumsum, yend=cumsum-count,
    color=stack),
    showSelected="facet",
    data = random.cumsums,
    size=10,
    stat = "identity",
    position="identity")
ggidentity+facet_grid(facet ~ .)
```

<!-- paragraph -->

Notez que nous avons utilisé `geom_segment` au lieu de `geom_bar` mais leur apparence est similaire.

<!-- paragraph -->

```{r Ch07-viz-identity}
animint(
  plot = ggidentity,
  time = list(variable = "facet", ms = 1000),
  duration = list(facet = 1000))
```

<!-- paragraph -->

## Ajouter des valeurs à un ensemble de sélection multiple, une à la fois {#multiple-selection}

<!-- paragraph -->

Animint ne prend pas en charge une brosse rectangulaire ou un lasso pour définir interactivement un ensemble de valeurs prises en charge.
<!-- comment -->
Au lieu de cela, animint prend en charge la sélection multiple en ajoutant des valeurs une par une à l'ensemble de sélection multiple.
<!-- comment -->
Utiliser le [sélecteur.types](Ch04-clickSelects.html#selector-types-option) pour déclarer une variable de sélection multiple.

<!-- paragraph -->

## Ajuster y au lieu d'utiliser vjust {#vjust}

<!-- paragraph -->

Pour l'alignement horizontal du texte, animint prend en charge l'utilisation de `hjust` dans R avec les valeurs les plus courantes : 0 pour l'alignement à gauche, 0,5 pour l'alignement au milieu et 1 pour l'alignement à droite.
<!-- comment -->
Animint traduit ces trois `hjust` valeurs en `text-anchor` dans les données affichées, à savoir

<!-- paragraph -->

Cependant, animint ne prend pas en charge l'alignement vertical du texte à l'aide de la propriété `vjust` dans R, car il n'y a pas de propriété qui puisse être utilisée pour l'alignement vertical du texte dans SVG.

<!-- paragraph -->

```{r}
line.df <- data.frame(just=c(0, 0.5, 1))
text.df <- expand.grid(
  vjust=line.df$just,
  hjust=line.df$just)
gg.lines <- ggplot()+
  theme_bw()+
  geom_vline(aes(xintercept=just), data=line.df, color="grey")+
  geom_hline(aes(yintercept=just), data=line.df, color="grey")
gg.vjust <- gg.lines+
  geom_text(aes(
    hjust, vjust, label="qwerty", hjust=hjust, vjust=vjust),
    size=10,
    data=text.df)
gg.vjust+ggtitle("R graphics devices respect aes(vjust)")
```

<!-- paragraph -->

Notez que hjust et vjust sont respectés dans le ggplot statique ci-dessus.
<!-- comment -->
En revanche, considérons l'animint ci-dessous.
<!-- comment -->
Le graphique de gauche devrait être le même que le ggplot ci-dessus, mais il y a des différences évidentes en termes de placement vertical des éléments de texte.

<!-- paragraph -->

```{r Ch07-viz-just}
(viz.just <- animint(
  vjust=gg.vjust+
    ggtitle("animint does not support aes(vjust)"),
  workaround=gg.lines+
    ggtitle("workaround: no aes(vjust), add to y")+
    geom_text(aes(
      hjust, vjust + (0.5-vjust)*0.03 - 0.01,
      label="qwerty", hjust=hjust),
      data=text.df)))
```

<!-- paragraph -->

La solution de contournement dans animint est illustrée dans le panneau de droite ci-dessus.
<!-- comment -->
Vous pouvez ajuster la position verticale `y` des éléments de texte pour lesquels vous auriez utilisé la fonction `vjust`.

<!-- paragraph -->

Il est possible d'implémenter `vjust` dans animint, mais nous n'avons pas encore eu le temps d'y travailler.
<!-- comment -->
Si vous souhaitez l'implémenter, nous serions plus qu'heureux d'accepter une Pull Request.
<!-- comment -->
Nous avons déjà un [qui explique comment l'implémenter.](https://github.com/tdhock/animint/issues/148) .

<!-- paragraph -->

## Ordonner les graphiques sur la page {#order-plots}

<!-- paragraph -->

Actuellement, la seule façon d'organiser une viz de données multiplot est d'utiliser l'ordre des ggplots dans l'animint. `viz` dans la liste animint.
<!-- comment -->
Les graphiques apparaîtront sur la page web dans le même ordre que celui dans lequel ils apparaissent dans l'animint. `viz` .
<!-- comment -->
Par exemple, comparez l'image de données ci-dessous avec l'image de données de la section précédente.

<!-- paragraph -->

```{r Ch07-viz-order}
animint(
  first=viz.just$workaround,
  second=viz.just$vjust)
```

<!-- paragraph -->

Notez que l'ordre des graphiques est inversé par rapport à la viz de données de la section précédente.
<!-- comment -->
La principale limite de cette méthode de mise en page des graphiques est que seul l'ordre peut être contrôlé.
<!-- comment -->
Par exemple, en fonction de la largeur de l'élément de la page web dans lequel la viz de données ci-dessus est affichée, le deuxième graphique apparaîtra soit sous le premier graphique, soit à sa droite.

<!-- paragraph -->

Si vous avez une idée pour une meilleure façon de définir la mise en page des graphiques dans une animint, [merci de nous en faire part](https://github.com/tdhock/animint2/issues) !

<!-- paragraph -->

## Éviter les bornes des étiquettes de texte (histogrammes) {#line-breaks}

<!-- paragraph -->

Lors de l'affichage d'un ggplot à l'aide des périphériques graphiques R habituels, l'utilisation d'une borne des classes (histogrammes) ou d'une nouvelle ligne `\n` dans un `geom_text` entraîne l'apparition de plusieurs lignes de texte sur le graphique.

<!-- paragraph -->

```{r}
gg.return <- ggplot()+
  geom_text(aes(
    hjust, vjust, label=sprintf("x=%.1f\ny=%.1f", hjust, vjust)),
    size=3,
    data=text.df)
gg.return
```

<!-- paragraph -->

Cependant, animint ne prend en charge que le dessin de la première ligne de texte.

<!-- paragraph -->

```{r Ch07-viz-return}
animint(gg.return)
```

<!-- paragraph -->

Il serait bon de prendre en charge les lignes multiples dans les `geom_text` mais nous n'avons pas encore eu le temps de l'implémenter.
<!-- comment -->
Cependant, nous avons [un problème](https://github.com/tdhock/animint/issues/149) et nous serions prêts à accepter une Pull Request qui implémente cela.

<!-- paragraph -->

En attendant, la solution de contournement consiste à utiliser un seul `geom_text` pour chaque ligne de texte que vous souhaitez afficher :

<!-- paragraph -->

```{r Ch07-viz-two-lines}
gg.two.lines <- ggplot()+
  geom_text(aes(
    hjust, vjust, label=sprintf("x=%.1f", hjust)),
    size=3,
    data=text.df)+
  geom_text(aes(
    hjust, vjust-0.05, label=sprintf("y=%.1f", vjust)),
    size=3,
    data=text.df)
gg.two.lines
animint(gg.two.lines)
```

<!-- paragraph -->

## Éviter certaines options du thème ggplot {#theme-options}

<!-- paragraph -->

L'un des objectifs d'animint est de prendre en charge [toutes les options du thème](http://docs.ggplot2.org/current/theme.html) mais nous n'avons pas encore eu le temps de les implémenter toutes.
<!-- comment -->
S'il y a une option de thème que vous utilisez et qu'animint ne prend pas encore en charge, alors envoyez-nous une Pull Request.
<!-- comment -->
La liste suivante documente tous les `theme` prises en charge par animint.

<!-- paragraph -->

- `panel.margin` désigne la distance entre les panneaux, et est utilisé dans le format [idiome des facettes d'économie d'espace](Ch99-appendix.html#space-saving-facets) pour éliminer la distance entre les panneaux.
<!-- comment -->
- `panel.grid.major` est utilisé pour dessiner les lignes de la grille qui sont désignées par l'élément `breaks` l'argument de l'échelle.
<!-- comment -->
- `panel.grid.minor` est utilisé pour dessiner les lignes de la grille entre les lignes principales de la grille.
<!-- comment -->
- `panel.background` est utilisé pour le `<rect>` en arrière-plan de chaque panneau.
<!-- comment -->
- `panel.border` est utilisé pour la bordure `<rect>` de chaque panneau (sur l'arrière-plan `<rect>` ).
<!-- comment -->
- `legend.position="none"` fonctionne pour cacher toutes les légendes, mais aucune des autres positions de légende n'est prise en charge (les légendes apparaissent toujours à droite du graphique).

<!-- paragraph -->

Les options de thème suivantes peuvent être définies pour `element_blank` pour masquer les axes.

<!-- paragraph -->

- `axis.title`, `axis.title.x`, `axis.title.y` désignent le titre de l'axe.
<!-- comment -->
- `axis.ticks`, `axis.ticks.x`, `axis.ticks.y` désignent les tics de l'axe.
<!-- comment -->
- `axis.line`, `axis.line.x`, `axis.line.y` désignent la ligne d'axe.
<!-- comment -->
- `axis.text`, `axis.text.x`, `axis.text.y` désignent le texte de l'étiquette de l'axe, et prennent en charge la fonction `angle` et `hjust` des arguments `element_text`.

<!-- paragraph -->

## Facettes avec plusieurs variables par axe {#facet-strips}

<!-- paragraph -->

Animint prend en charge `facet_grid` pour créer des visualisations de données à plusieurs panneaux, mais ne prend en charge que de manière limitée les variables multiples par axe.
<!-- comment -->
Par exemple, le ggplot ci-dessous utilise deux variables pour créer des facettes verticales, ce qui se traduit par deux étiquettes de bande lorsqu'elles sont affichées avec ggplot2.

<!-- paragraph -->

```{r}
data(intreg)
signals.df <- transform(
  intreg$signals,
  person=sub("[.].*", "p", signal),
  chromosome=sub(".*[.]", "c", signal))
two.strips <- ggplot()+
  theme_animint(height=600)+
  facet_grid(person + chromosome ~ ., scales="free")+
  geom_point(aes(base/1e6, logratio), data=signals.df)
two.strips+ggtitle("two strip labels on the right")
```

<!-- paragraph -->

En revanche, animint affiche le même ggplot ci-dessous en n'utilisant qu'une seule étiquette de bande.

<!-- paragraph -->

```{r Ch07-viz-strips}
animint(two.strips+ggtitle("only one strip label"))
```

<!-- paragraph -->

Il serait intéressant de prendre en charge plusieurs étiquettes de bande par axe, mais nous n'avons pas encore eu le temps de l'implémenter.
<!-- comment -->
Si vous souhaitez implémenter cette fonctionnalité, nous serions heureux d'accepter votre Pull Request.

<!-- paragraph -->

## Définition interactive de mappings esthétiques à l'aide de shiny {#shiny-aes}

<!-- paragraph -->

Normalement, les mappings esthétiques sont définis une fois dans le code R, et ne peuvent pas être modifiés après avoir affiché un animint.
<!-- comment -->
Une façon de surmonter cette limitation est de définir `shiny` qui sont utilisées pour l'esthétique de l'animint, comme dans l'exemple suivant.

<!-- paragraph -->

```{r, eval=FALSE}
shiny::runApp(system.file(
  "examples", "shiny-WorldBank", package="animint2"))
```

<!-- paragraph -->

## Calcul interactif {#shiny-computation}

<!-- paragraph -->

Une autre limitation est que animint ne peut afficher que des données qui peuvent être calculées et stockées dans un tableau de données avant la création de la visualisation.
<!-- comment -->
Cela signifie qu'animint n'est pas approprié lorsqu'il y a plus de sous-ensembles de données à tracer qu'il n'est possible d'en calculer.
<!-- comment -->
Dans ce cas, il serait préférable d'utiliser shiny.

<!-- paragraph -->

## Résumé du chapitre et exercices {#Ch07-exercises}

<!-- paragraph -->

Nous avons discuté des limitations de l'implémentation actuelle de animint2, et implémenté plusieurs solutions de contournement.

<!-- paragraph -->

Exercices :

<!-- paragraph -->

- Réaliser un ggplot à facettes avec `stat_bin` qui ne fonctionnera pas avec animint lorsque la variable facette est utilisée comme variable showSelected.
<!-- comment -->
Calculez vous-même le statut pour chaque facette, et utilisez `stat_identity` pour que cela fonctionne avec animint.
<!-- comment -->
- Faire un ggplot qui s'affiche bien en utilisant \`facet\_grid(.
<!-- comment -->
\~ var, scales="free")`but does not display well in animint with`showSelected=var\`.
<!-- comment -->
Pour résoudre le problème, calculez une version normalisée de `var` et l'utiliser pour le `showSelected` et l'utiliser pour la variable

<!-- paragraph -->

Suivant, [Chapitre 8](Ch08-WorldBank-facets.html) explique comment créer une visualisation multi-panneaux des données de la Banque mondiale.

<!-- paragraph -->



---
title: Le mot-clé `showSelected`
layout: default
output: bookdown::html_chapter
---

```{r}
#| echo: false
knitr::opts_chunk$set(fig.path="Ch03-figures/")
```

Dans ce chapitre, nous vous présentons `showSelected`, l'un des deux principaux mots-clés introduits par `animint2` pour la visualisation interactive de données.
<!-- comment -->
Après avoir lu ce chapitre, vous saurez :

<!-- comment -->

- Utiliser le mot-clé `showSelected` dans vos esquisses pour spécifier des geoms pour lesquels seul un sous-ensemble de données doit être tracé à la fois.
<!-- comment -->
- Utiliser les menus de sélection pour modifier le sous-ensemble de données tracées.
<!-- comment -->
- Préciser des transitions fluides entre les sous-ensembles de données avec `aes(key)` et l'option `duration`.
<!-- comment -->
- Créer des visualisations de données animées à l'aide de l'option `time`.

<!-- comment -->

## Esquisses avec `showSelected` {#esquisses}

Dans le chapitre 2, nous avons expliqué comment planifier les codes nécessaires pour créer une visualisation avec une esquisse qui comprend les éléments principaux (geoms, axes, légendes, données).
<!-- comment -->
Dans cette section, nous allons expliquer comment le mot-clé `showSelected` peut être utilisé dans les esquisses.
<!-- comment -->
Le mot-clé `showSelected` est utilisé pour préciser les variables à utiliser pour sélectionner un sous-ensemble de données.
<!-- comment -->
Chaque geom possède son propre ensemble de données et sa propre définition de variables `showSelected`.
<!-- comment -->
Cela signifie que chaque geom peut afficher son propre sous-ensemble de données (qui est différent que les autres geoms).

<!-- comment -->

En fait, nous avons déjà utilisé le mot-clé `showSelected` : il avait été généré automatiquement par les légendes interactives que nous avions créées dans les deux chapitres précédents.
<!-- comment -->
Considérons, par exemple, [la courbe de Keeling du chapitre 1 présentée ci-dessous](Ch01-motivation.html#large-data).

<!-- comment -->

![Esquisse de la courbe de Keeling](Ch03-viz-co2.png)

<!-- comment -->

L'esquisse ci-dessus comprend `showSelected=mois` pour le `geom_point` ce qui signifie qu'elle doit afficher le sous-ensemble de données pour les mois sélectionnés.
<!-- comment -->
En revanche, puisque `geom_line` n'inclut pas `showSelected`, il affiche toujours l'ensemble complet des données (peu importe les mois sélectionnés).

<!-- comment -->

Prenons un autre exemple : l'esquisse ci-dessous de la première visualisation de données de la Banque mondiale, du chapitre 2.

<!-- comment -->

![Esquisse Banque mondiale avec showSelected région](Ch03-viz-showSelectedColor.png)

L'esquisse ci-dessus spécifie `showSelected=région` pour le `geom_point`, ce qui signifie qu'elle doit afficher le sous-ensemble de données pour les régions sélectionnées.

<!-- comment -->

Notez que l'esquisse dans chapitre 2 ne précisait pas explicitement `showSelected=région`.
<!-- comment -->
Nous avions simplement indiqué `aes(color=région)`, et `animint2` a automatiquement ajouté une variable `showSelected` correspondante.
<!-- comment -->
En général, `animint2` rajoute un mot-clé `showSelected` pour chaque variable utilisée dans une légende qualitative.

<!-- comment -->

Cependant, le mot-clé `showSelected` n'est pas limité aux légendes qualitatives.
<!-- comment -->
Vous pouvez utiliser `showSelected` pour toutes les variables de votre choix, en précisant explicitement les variables dans l'argument `showSelected` du geom.

<!-- comment -->

Chaque variable utilisée avec `showSelected` est traitée par `animint2` comme une variable de sélection.
<!-- comment -->
Par exemple, la visualisation de la courbe de Keeling a une variable de sélection (`mois`), tout comme la visualisation de la Banque mondiale (`région`).
<!-- comment -->
Pour chaque variable de sélection, `animint2` stocke les valeurs sélectionnées.
<!-- comment -->
Lorsque la sélection change, `animint2` met à jour le sous-ensemble de données affiché.

<!-- comment -->

Les deux visualisations présentées ci-dessus ne comportent qu'une seule variable de sélection.
<!-- comment -->
Par contre, une visualisation de données peut avoir autant de variables de sélection que vous le souhaitez.
<!-- comment -->
Dans la section suivante, nous étudierons une visualisation des données de la Banque mondiale, avec les variables de sélection `région`  et `année`.

<!-- comment -->

## Sélection de sous-ensembles avec menus {#selection-avec-menus}

<!-- comment -->

Considérons l'esquisse suivante avec une variable `showSelected` de plus et un ensemble de données différent.

<!-- comment -->

![Esquisse Banque mondiale avec showSelected région et année](Ch03-viz-scatter.png)

<!-- comment -->

Notez qu'il y a deux variables `showSelected` : `région` et `année`.
<!-- comment -->
Notez également que les données sont spécifiées pour toutes les années (mais une seule année sera affichée à la fois, grâce au `showSelected=année`).
<!-- comment -->
Ci-dessous, nous traduisons l'esquisse en code R.

<!-- comment -->

```{r}
library(animint2)
data(BanqueMondiale, package="animint2fr")
nuage <- ggplot()+
  geom_point(aes(
    x=espérance.de.vie, y=taux.de.fertilité, color=région),
    showSelected="année",
    data=BanqueMondiale)
nuage
```

<!-- comment -->

Notez que le code ci-dessus contient le mot-clé `showSelected`, une nouveauté dans `animint2` par rapport à `ggplot2`.
<!-- comment -->
Le mot-clé `showSelected` est ignoré lorsque le graphique est affiché comme ci-dessus, avec les fonctions d'affichage habituelles de R, qui dessinent un nuage de points incluant toutes les années.
<!-- comment -->

En revanche, donner le code ci-dessus comme argument pour `animint()` donne la visualisation interactive ci-dessous, qui dessine une année à la fois.

<!-- comment -->

```{r Ch03-viz-scatter}
animint(nuage)
```

<!-- comment -->

Notez que la visualisation ci-dessus comporte deux variables de sélection : `région` et `année` (`color=région` fait automatiquement de `région` une variable `showSelected`).
<!-- comment -->
Chaque variable dispose d'un menu sous la visualisation de données pour la modification de la sélection en cours.
<!-- comment -->
Dans cette visualisation, ces menus sont affichés par défaut.
<!-- comment -->
Pour les masquer, cliquez sur le bouton "Hide selection menus", et pour les réafficher sur "Show selection menus".

<!-- comment -->

Les variables discrètes, telles que `région`, ont une sélection multiple par défaut, de sorte que plusieurs valeurs sont sélectionnées et affichées à la fois.
<!-- comment -->
Essayez de modifier la région sélectionnée dans la légende interactive et dans le menu de sélection.
<!-- comment -->
Lorsque vous modifiez la sélection à l'aide d'une des méthodes, la légende interactive et le menu de sélection sont tous les deux mis à jour, pour refléter la nouvelle sélection.

<!-- comment -->

Nous utilisons les termes "manipulation directe" et "manipulation indirecte" pour décrire ces différentes façons de modifier la sélection.
<!-- comment -->
La manipulation directe est généralement plus facile à comprendre, parce qu'il s'agit de cliquer sur les objets que l'on souhaite modifier dans le graphique.
<!-- comment -->
De leur coté, les techniques de manipulation indirecte, telles que les menus, sont utiles dans d'autres cas (par exemple, la sélection du nom d'un pays).
<!-- comment -->
Dans la visualisation ci-dessus, vous pouvez modifier la valeur de `région` en utilisant soit la légende, soit le menu.
<!-- comment -->
L'utilisation de la légende est une technique de manipulation plus directe, puisque la légende est dessinée plus près du nuage de points qui sera mis à jour.

<!-- comment -->

D'autres variables de sélection, comme `année`, ont une sélection simple par défaut, de sorte qu'une seule valeur est sélectionnée et affichée à la fois.      Essayez de modifier la valeur sélectionnée pour la variable `année` à l'aide du menu de sélection.
<!-- comment -->
Vous devriez voir le nuage de points se mettre à jour immédiatement pour afficher le taux de fertilité et l'espérance de vie de tous les pays au cours de l'année que vous avez sélectionnée.

<!-- comment -->

Exercice couches multiples : ajoutez un autre geom à ce nuage de points interactif.
<!-- comment -->
Comme dans le [chapitre 2](Ch02-ggplot2.html#multi-layer), vous pouvez utiliser un `geom_text` pour afficher le nom de chaque pays (facile), ou un `geom_text` pour afficher l'année sélectionnée (moyen), ou un `geom_path` pour afficher les données des 5 années précédentes (difficile).
<!-- comment -->
Astuce : utilisez `showSelected=année` dans tous les geoms.

<!-- comment -->

Exercice multi-plot : ajoutez une série temporelle à la visualisation de données ci-dessus.
<!-- comment -->
Comme dans le [chapitre 2](Ch02-ggplot2.html#multi-plot), vous pouvez utiliser un `geom_line` pour afficher le taux de fertilité de chaque pays, pour toutes les années.
<!-- comment -->
Ajoutez un `geom_vline` avec `showSelected=année` pour mettre en évidence l'année sélectionnée.

<!-- comment -->

## Transitions : l'option `duration` et `aes(key)` {#duration-key}

<!-- comment -->

Vous avez peut-être remarqué la présence de boutons sous chaque visualisation de données créée par animint2.
<!-- comment -->
Cliquez sur le bouton "Show animation controls" de la visualisation présentée ci-dessus.
<!-- comment -->
Vous verrez alors que ce tableau contient une ligne pour chaque variable de sélection.
<!-- comment -->
Les zones de texte indiquent le nombre de millisecondes utilisées pour les durées de transition après la mise à jour de chaque variable de sélection.
<!-- comment -->
Pour chaque variable de sélection, la durée de transition par défaut est 0, ce qui signifie que les données seront immédiatement placées à leur nouvelle position après la mise à jour de chaque variable.

<!-- comment -->

Pour illustrer l'importance des durées de transition, essayez de changer la valeur de la durée de transition de la variable `année` pour 2000.
<!-- comment -->
Ensuite, utilisez le menu pour modifier la valeur sélectionnée de la variable `année`.
<!-- comment -->
Vous devriez voir les points de données se déplacer lentement vers leurs nouvelles positions en 2 secondes.

<!-- comment -->

Certaines transitions n'entraînent qu'un léger déplacement des points vers des positions proches (par exemple, 1979-1980).
<!-- comment -->
D'autres transitions entraînent un déplacement beaucoup plus important des points, vers des localisations plus éloignées (par exemple 1980-1981).
<!-- comment -->
Pourquoi?

<!-- comment -->

Les transitions fluides n'ont de sens que pour les points de données qui existent à la fois avant et après la modification de la sélection.
<!-- comment -->
Dans le code R ci-dessous, nous calculons un tableau de contingence des points de données qui peuvent être tracés pour chacune de ces trois années.

<!-- comment -->

```{r}
trois.ans <- subset(BanqueMondiale, 1979 <= année & année <= 1981)
can.plot <- with(trois.ans, {
  (!is.na(espérance.de.vie)) & (!is.na(taux.de.fertilité))
})
table(trois.ans$année, can.plot)
```

<!-- comment -->

Le tableau de contingence ci-dessus montre clairement que 187 points peuvent être tracés en 1979 et 1980. 
<!-- comment -->
Cependant, en 1981, il y a un point de données supplémentaire correspondant à un pays pour lequel nous n'avions pas de données en 1980. 
<!-- comment -->
Nous présentons ci-dessous les données de ce pays, le Kosovo.

<!-- comment -->

```{r}
subset(trois.ans, pays=="Kosovo")
```

<!-- comment -->

On voit bien que les données sur le taux de fertilité et sur l’espérance de vie sont absentes du tableau pour le Kosovo en 1979 et en 1980.
<!-- comment -->
Il ne serait donc pas logique d’effectuer une transition fluide pour ce pays, puisque les données ne sont présentes ni avant ni après la transition.
<!-- comment -->
Comment le spécifier dans la visualisation de données? 
<!-- comment -->
Dans le code ci-dessous, nous utilisons `aes(key=pays)` pour spécifier que la variable `pays` doit être utilisée pour faire correspondre les points de données avant et après la modification de la sélection.

<!-- comment -->

```{r}
nuage.key <- ggplot()+
  geom_point(aes(
    x=espérance.de.vie, y=taux.de.fertilité, color=région,
    key=pays),
    showSelected="année",
    data=BanqueMondiale)
```

<!-- comment -->

Le `aes(key)` dans le ggplot ci-dessus n'a de sens que pour la visualisation interactive des données, il est donc ignoré lorsqu'il est affiché avec les périphériques graphiques R habituels.
<!-- comment -->
Cependant, si nous affichons ce ggplot en utilisant `animint2`, la variable `pays` permettra des durées de transitions pertinentes.
<!-- comment -->
Pour spécifier une durée de transition par défaut pour la variable `année` nous utilisons l'option `duration` dans l'image de données ci-dessous.

<!-- comment -->

```{r Ch03-viz-duration}
(viz.duration <- animint(nuage.key, duration=list(année=2000)))
```

<!-- comment -->

L'option `duration` doit être une liste nommée.
<!-- comment -->
Chaque nom doit être une variable de sélection et chaque valeur doit spécifier le nombre de millisecondes à utiliser pour la durée de la transition lorsque la valeur sélectionnée de cette variable est modifiée.

<!-- comment -->

Si vous cliquez sur "Show animation controls" (Afficher les contrôles d'animation) dans le graphique ci-dessus, vous verrez que la zone de texte pour la variable année est 2000, comme spécifié dans le code R.
<!-- comment -->
Si vous changez la sélection de 1980 à 1981, vous devriez voir une transition correcte.

<!-- comment -->

De façon générale, `aes(key)` doit être spécifié pour tous les geoms qui utilisent le mot-clé `showSelected` avec une variable qui apparaît dans l'option `duration`.
<!-- comment -->
Dans cet exemple, nous avons utilisé l'option `duration` pour spécifier une transition fluide pour la variable `année`.
<!-- comment -->
Puisque nous utilisons `showSelected=année` dans `geom_point` nous avons également spécifié `aes(key)` pour ce geom.

<!-- comment -->

## Animation : l'option `time` {#animation-time}

<!-- comment -->

L'option `time`  permet de spécifier une variable à utiliser pour l'animation.
<!-- comment -->
Dans le code ci-dessous, on utilise l'option `time` pour préciser `année` comme variable d'animation, et mettre l’animation à jour toutes les 2000 millisecondes.

```{r Ch03-viz-duration-time}
viz.duration.time <- viz.duration
viz.duration.time$time <- list(variable="année", ms=2000)
viz.duration.time
```

On dit que la visualisation ci-dessus est animée, parce que la sélection pour `année` va changer toutes les deux secondes.

<!-- comment -->

Exercice : réalisez une visualisation de données animée qui n'utilise PAS de transitions fluides. 
<!-- comment -->
Indice : créez une liste de ggplots qui intègrent l'option `time` mais pas l'option `duration`.

<!-- comment -->

## Résumé du chapitre et exercices {#Ch03-exercises}

<!-- comment -->

Dans ce chapitre, nous avons expliqué l'utilisation du mot-clé `showSelected`, des menus de sélection, des transitions et de l'animation.

<!-- comment -->

Exercices :

<!-- comment -->

- Réalisez une version améliorée de `vis.alignée` du chapitre précédent. Au lieu de fixer l'année à 1975, utilisez `showSelected=année` pour que l'utilisateur puisse sélectionner une année. Ajoutez des geoms qui affichent l'année sélectionnée : un `geom_text` sur le nuage de points et un `geom_vline` sur la série chronologique.
<!-- comment -->
- Traduisez l'un des [exemples de library(animation)](https://yihui.name/animation/examples/) en animint2. Indice : dans le code de `library(animation)`, il y a toujours une boucle `for` dans l'option `time`. Au lieu d'appeler une fonction d'affichage à l'intérieur de la boucle `for`, utilisez [l'idiome liste de tableaux de données](Ch99-appendix.html#list-of-data-tables)  pour stocker les données qui doivent être tracées. Utilisez ensuite ces données avec `showSelected` pour créer des ggplots, et affichez-les avec `animint2`.

<!-- comment -->

Dans le [chapitre 4](Ch04-clickSelects.html), nous vous expliquerons le mot-clé `clickSelects` qui indique un geom sur lequel on peut cliquer pour mettre à jour une variable de sélection.

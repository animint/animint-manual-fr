---
title: showSelected
layout: default
output: bookdown::html_chapter
---

# Chapter 3, the showSelected keyword

<!-- comment -->

```{r setup, echo=FALSE}
knitr::opts_chunk$set(fig.path="Ch03-figures/")
```

<!-- comment -->

Ce chapitre explique showSelected, l'un des deux principaux mots-clés introduits par `animint2` pour la visualisation interactive de données.
<!-- comment -->
Après avoir lu ce chapitre, vous serez en mesure de

<!-- comment -->

- Utiliser le mot-clé `showSelected` dans vos esquisses pour spécifier des geoms pour lesquels seul un sous-ensemble de données doit être tracé à la fois.
<!-- comment -->
- Utilisez les menus de sélection pour modifier le sous-ensemble de données tracées.
<!-- comment -->
- Spécifiez des transitions fluides entre les sous-ensembles de données à l'aide de l'option `duration` et `aes(key)`.
<!-- comment -->
- Créez des visualisations de données animées à l'aide de l'option `time`.

<!-- comment -->

## Esquisses avec `showSelected` {#esquisses}

<!-- comment -->

Dans cette section, nous allons expliquer comment le mot-clé `showSelected` peut être utilisé dans les esquisses.
<!-- comment -->
Le mot-clé `showSelected` spécifie une variable à utiliser pour sélectionner un sous-ensemble de données.
<!-- comment -->
Chaque geom d'une visualisation de données possède son propre ensemble de données, et sa propre définition des variables `showSelected`.
<!-- comment -->
Cela signifie que des geoms différents peuvent spécifier des ensembles de données et des mots-clés `showSelected` différents pour afficher des sous-ensembles de données différents.

<!-- comment -->

En fait, nous avons déjà utilisé le mot-clé `showSelected`, qui a été automatiquement créé par les légendes interactives que nous avons créées dans les deux chapitres précédents.
<!-- comment -->
Par exemple, considérons l'esquisse ci-dessous, de [la courbe de Keeling du chapitre 1](Ch01-motivation.html#large-data).

<!-- comment -->

![courbe de Keeling](Ch03-viz-co2.png)

<!-- comment -->
L'esquisse ci-dessus comprend `showSelected=mois` pour le `geom_point` ce qui signifie qu'il doit afficher le sous-ensemble de données pour les mois sélectionnés.
<!-- comment -->
En revanche, étant donné que l'élément `geom_line` n'inclut pas `showSelected`, il affiche toujours l'ensemble complet des données (quels que soient les mois sélectionnés).

<!-- comment -->

Prenons un autre exemple : le dessin ci-dessous de la première visualisation de données de la banque mondiale, du chapitre 2.

<!-- comment -->

![banque mondiale avec showSelected](Ch03-viz-showSelectedColor.png)

<!-- comment -->

L'esquisse ci-dessus spécifie `showSelected=région`  pour le `geom_point`, ce qui signifie qu'il doit afficher le sous-ensemble de données pour les régions sélectionnées.

<!-- comment -->

Notez que le code que nous avons utilisé dans chapitre 2 ne spécifiait pas explicitement `showSelected=région`.
<!-- comment -->
Au lieu de cela, nous avons spécifié `aes(color=région)` et `animint2` a automatiquement rajouté un mot-clé `showSelected`.
<!-- comment -->
En général, `animint2` rajoute un mot-clé `showSelected` pour chaque variable utilisée dans une légende qualitative.

<!-- comment -->

Cependant, le mot-clé `showSelected` n'est pas limité aux légendes qualitatives.
<!-- comment -->
Vous pouvez utiliser les mots-clés `showSelected` pour toutes les variables que vous souhaitez, en spécifiant explicitement les noms des variables dans l'argument `showSelected` du geom.

<!-- comment -->

Chaque variable utilisée avec showSelected est traitée par `animint2` comme une variable de sélection.
<!-- comment -->
Par exemple, la visualisation de la courbe de Keeling a une variable de sélection (`mois`), tout comme la visualisation de la Banque Mondiale (`région`).
<!-- comment -->
Pour chaque variable de sélection, `animint2` stocke les valeurs actuellement sélectionnées.
<!-- comment -->
Lorsque la sélection change, `animint2` met à jour le sous-ensemble de données affiché.

<!-- comment -->

Chacune des visualisations esquissées ci-dessus ne comporte qu'une seule variable de sélection.
<!-- comment -->
Cependant, une visualisation de données peut comporter un nombre quelconque de variables de sélection.
<!-- comment -->
Dans la section suivante, nous allons étudier une visualisation des données de la banque mondiale, qui comporte des variables de sélection pour `région`  et `année`.

<!-- comment -->

## Sélection de sous-ensembles avec menus {#selection-avec-menus}

<!-- comment -->

Considérons l'esquisse suivant, avec une variable `showSelected` de plus, et avec un différent ensemble de données.

<!-- comment -->

![esquisse banque mondiale avec showSelected](Ch03-viz-scatter.png)

<!-- comment -->

Notez qu'il y a deux variables `showSelected` : `région` et `année`.
<!-- comment -->
Notez également que les données sont spécifiées pour toutes les années (mais une seule année sera affichée à la fois, grâce au `showSelected=année`).
<!-- comment -->
Ci-dessous, nous traduisons l'esquisse en code R.

<!-- comment -->

```{r}
library(animint2)
data(WorldBank)
WorldBank$espérance.de.vie <- WorldBank$life.expectancy
WorldBank$taux.de.fertilité <- WorldBank$fertility.rate
en2fr.region <- c(
  "East Asia & Pacific"="Asie de l'est et pacifique",
  "Europe & Central Asia"="Europe et Asie centrale",
  "Latin America & Caribbean"="Amérique latine et Caraïbes",
  "Middle East & North Africa"="Moyen orient et Magreb",
  "North America"="Amérique du nord",
  "South Asia"="Asie du sud",
  "Sub-Saharan Africa"="Afrique subsaharienne")
WorldBank$région <- factor(sub(" \\(.*", "", WorldBank$region), names(en2fr.region), en2fr.region)
WorldBank$année <- WorldBank$year
scatter <- ggplot()+
  geom_point(aes(
    x=espérance.de.vie, y=taux.de.fertilité, color=région),
    showSelected="année",
    data=WorldBank)
scatter
```

<!-- comment -->

Notez que le code ci-dessus contient l'argument `showSelected=année`, ce qui est nouveau dans `animint2`, par rapport à `ggplot2`.
<!-- comment -->
L'argument `showSelected=année` est ignoré lorsque le graphe est affiché comme ci-dessus, avec les fonctions d'affichage habituelles dans R, qui dessinent un nuage de points qui comprend toutes les années.
<!-- comment -->

En revanche, donner le code ci-dessus comme argument pour `animint()` donne la visualisation interactive ci-dessous, qui dessine une année à la fois.

<!-- comment -->

```{r Ch03-viz-scatter}
animint(scatter)
```

<!-- comment -->

Notez que la visualisation ci-dessus comporte deux variables de sélection : `région` et `année` (`color=région` fait que `région` est automatiquement une variable `showSelected`).
<!-- comment -->
Chaque variable dispose d'un menu en bas qui peut être utilisé pour modifier la sélection en cours.
<!-- comment -->
Dans cette visualisation, ces menus sont affichés par défaut.
<!-- comment -->
Ils peuvent être masqués en cliquant sur le bouton "Hide selection menus", et réaffichés en cliquant sur le bouton "Show selection menus".

<!-- comment -->

Les variables discrètes, telles que `région`, ont sélection multiple par défaut, de sorte que plusieurs valeurs sont sélectionnées et affichées à la fois.
<!-- comment -->
Essayez de modifier la région sélectionnée dans la légende interactive et dans le menu de sélection.
<!-- comment -->
Lorsque vous modifiez la sélection à l'aide de l'une ou l'autre méthode, la légende interactive et le menu de sélection sont tous les deux mises à jour, pour refléter la sélection actuelle.

<!-- comment -->

Nous utilisons les termes "manipulation directe" et "manipulation indirecte" pour décrire ces différentes façons de modifier la sélection.
<!-- comment -->
La manipulation directe est généralement plus facile à comprendre, parce qu'il s'agit de cliquer sur les objets dans le graphique que l'on souhaite modifier.
<!-- comment -->
En revanche, les techniques de manipulation indirecte, telles que les menus, sont utiles dans d'autres cas (par exemple, sélection d'un pays par nom).
<!-- comment -->
Dans la visualisation ci-dessus, vous pouvez modifier la valeur de `région` en utilisant soit la légende, soit le menu.
<!-- comment -->
L'utilisation de la légende est une technique de manipulation plus directe, puisque la légende est dessinée plus près du nuage de points qui sera mis à jour.

<!-- comment -->

D'autres variables de sélection, comme `année`, ont sélection simple par défaut, de sorte qu'une seule valeur est sélectionnée et affichée à la fois.
<!-- comment -->
Essayez de modifier la valeur sélectionnée de la variable `année`, à l'aide du menu de sélection.
<!-- comment -->
Vous devriez voir le nuage de points se mettre à jour immédiatement pour afficher le taux de fértilité et l'espérance de vie de tous les pays au cours de l'année que vous avez sélectionnée.

<!-- comment -->

Exercice multi-couche : ajoutez un autre geom à ce nuage de points interactif.
<!-- comment -->
Comme dans [Chapitre 2](Ch02-ggplot2.html#multi-layer) vous pouvez utiliser `geom_text` pour afficher le nom de chaque pays (facile), ou `geom_text` pour afficher l'année sélectionnée (moyen), ou `geom_path` pour afficher les données des 5 années précédentes (difficile).
<!-- comment -->
Astuce : utiliser `showSelected=année` dans tous les geoms.

<!-- comment -->

Exercice multi-geom : ajoutez une série temporelle à la visualisation de données ci-dessus.
<!-- comment -->
Comme dans [Chapitre 2](Ch02-ggplot2.html#multi-plot) vous pouvez utiliser un `geom_line` pour afficher le taux de fértilité de chaque pays, pour toutes les années.
<!-- comment -->
Utiliser `geom_vline` avec `showSelected=année` pour mettre en évidence l'année sélectionnée.

<!-- comment -->

## Transitions: the duration option and key aesthetic {#duration-key}

<!-- comment -->

You may have noticed that there are buttons at the bottom of each data visualization created by animint.
<!-- comment -->
Try clicking the "Show animation controls" button above.
<!-- comment -->
This table contains a row for each selection variable.
<!-- comment -->
The text boxes show the number of milliseconds that are used for transition durations after updating each selection variable.
<!-- comment -->
The default transition duration for each selection variable is 0, meaning data will be immediately placed at their new positions after updating each variable.

<!-- comment -->

To illustrate the significance of transition durations, try changing the transition duration of the year variable to 2000.
<!-- comment -->
Then, change the selected value of the year variable.
<!-- comment -->
You should see the data points move slowly to their new positions, over a duration of 2 seconds.

<!-- comment -->

Some transitions result in points moving only a little bit, to nearby positions (for example, 1979-1980).
<!-- comment -->
Other transitions result in points moving a lot more, to far away locations (for example, 1980-1981). 
<!-- comment -->
Why is that?

<!-- comment -->

Smooth transitions only make sense for data points that exist both before and after changing the selection.
<!-- comment -->
In the R code below we compute a table of counts of data points that can be plotted in each of these three years.

<!-- comment -->

```{r}
three.years <- subset(WorldBank, 1979 <= year & year <= 1981)
can.plot <- with(three.years, {
  (!is.na(life.expectancy)) & (!is.na(fertility.rate))
})
table(three.years$year, can.plot)
```

<!-- comment -->

It is clear from the table above that there are 187 points that can be plotted in 1979 and 1980.
<!-- comment -->
However, in 1981 there is one more data point, corresponding to a country for which we did not have data in 1980.
<!-- comment -->
Below we show the data for that country, Kosovo.

<!-- comment -->

```{r}
subset(three.years, country=="Kosovo")
```

<!-- comment -->

Indeed, the table above shows that fertility rate and life expectancy are missing for Kosovo during 1979-1980.
<!-- comment -->
Thus it does not make sense to do a smooth transition for countries such as Kosovo which would not be plotted either before or after the transition.
<!-- comment -->
How to specify that in the data visualization?
<!-- comment -->
In the code below, we use `aes(key=country)` to specify that the `country` variable should be used to match data points before and after changing the selection.

<!-- comment -->

```{r}
scatter.key <- ggplot()+
  geom_point(aes(
    x=life.expectancy, y=fertility.rate, color=region,
    key=country),
    showSelected="year",
    data=WorldBank)
```

<!-- comment -->

The `key` aesthetic in the ggplot above is only meaningful for interactive data visualization, so it ignored when rendering with the usual R graphics devices.
<!-- comment -->
However, if we render this ggplot using animint2, the `country` variable will be used to make sure transtion durations are meaningful.
<!-- comment -->
To specify a default transition duration for the `year` variable, we use the `duration` option in the data viz below.

<!-- comment -->

```{r Ch03-viz-duration}
(viz.duration <- animint(scatter.key, duration=list(year=2000)))
```

<!-- comment -->

The `duration` option must be a named list.
<!-- comment -->
Each name should be a selection variable, and each value should specify the number of milliseconds to use for a transition duration when the selected value of that variable is changed.

<!-- comment -->

If you click "Show animation controls" in the data viz above, you will see that the text box for the year variable is 2000, as specified in the R code.
<!-- comment -->
If you change the selection from 1980 to 1981, you should see a proper transition.

<!-- comment -->

In general the `key` aesthetic should be specified for all geoms that use `showSelected` with a variable that appears in the `duration` option.
<!-- comment -->
In this example, we used the `duration` option to specify a smooth transition for the `year` variable.
<!-- comment -->
Since we use `showSelected=year` in the `geom_point`, we also specified the `key` aesthetic for this geom.

<!-- comment -->

## Animation: the time option {#animation-time}

<!-- comment -->

The `time` option is used to specify a variable to use for animation.

<!-- comment -->

```{r Ch03-viz-duration-time}
viz.duration.time <- viz.duration
viz.duration.time$time <- list(variable="year", ms=2000)
viz.duration.time
```

<!-- comment -->

Exercise: make an animated data visualization that does NOT use smooth transitions.
<!-- comment -->
Hint: make a list of ggplots that has the `time` option but no `duration` option.

<!-- comment -->

## Résumé du chapitre et exercices {#exercises}

<!-- comment -->

This chapter explained the showSelected aesthetic, selection menus, transition durations, and animation.

<!-- comment -->

Exercises:

<!-- comment -->

- Make an improved version of `viz.aligned` from the previous chapter. Instead of fixing the year at 1975, use `showSelected=year` so that the user can select a year. Add geoms that show the selected year: a `geom_text` on the scatterplot, and a `geom_vline` on the time series.
<!-- comment -->
- Translate one of the [animation package examples](https://yihui.name/animation/examples/) to an animint. Hint: in the code for the animation package there is always a for loop over the time variable. Instead of calling a plotting function inside the for loop, use the [list of data tables idiom](Ch99-appendix.html#list-of-data-tables) to store the data that should be plotted. Then use those data along with `showSelected` to create ggplots, and render them using animint.

<!-- comment -->

Next, [Chapter 4](Ch04-clickSelects.html) explains the `clickSelects` keyword, which indicates a geom that can be clicked to update a selection variable.

<!-- comment -->



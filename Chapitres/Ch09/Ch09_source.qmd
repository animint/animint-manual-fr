# Vélos de Montréal

<!-- paragraph -->

```{r setup, echo=FALSE}
knitr::opts_chunk$set(fig.path="Ch09-figures/")
```

<!-- paragraph -->

Dans ce chapitre, nous explorerons plusieurs visualisations des données pour l'ensemble de données portant sur les vélos de Montréal.

<!-- paragraph -->

Plan du chapitre :

<!-- paragraph -->

- Nous commençons par quelques visualisations des données statiques.
<!-- comment -->
- Nous créons une visualisation interactive de la fréquence des accidents dans le temps.
<!-- comment -->
- Nous créons une visualisation interactive des données avec quatre graphiques, montrant les tendances mensuelles des accidents, les détails quotidiens et une carte des emplacements des compteurs.

<!-- paragraph -->

## Graphiques statiques {#static}

<!-- paragraph -->

Nous commençons par charger le fichier `montreal.bikes` qui n'est pas disponible dans la version CRAN de `animint2`, afin d'économiser de l'espace sur le CRAN.
<!-- comment -->
Par conséquent, pour accéder à ce jeu de données, vous devrez installer `animint2` depuis GitHub :

<!-- paragraph -->

```{r ghinstall}
tryCatch({
  data(montreal.bikes, package="animint2")
}, warning=function(w){
  devtools::install_github("tdhock/animint2")
})
```

Les données sont deux séries temporelles :

* `montreal.bikes$counter.counts` : les passages de vélos sur les compteurs, dans un tableau avec une ligne pour chaque combinaison de lieu et jour.
* `montreal.bikes$accidents` : les accidents, dans un tableau avec une ligne par accident.

Nous allons calculer des résumés par mois dans ces deux séries temporelles.

### Compteurs

Ci-dessous, nous affichons le tableau de données des compteurs de vélos.

```{r counterRange}
mois <- function(POSIXct)strftime(POSIXct, "%Y-%m")
library(data.table)
(passages_dt <- data.table(montreal.bikes$counter.counts)[, .(
  lieu = location,
  date,
  mois.str = mois(date),
  passages=count)])
```

Ci-dessous, nous voyons une ligne pour chaque combinaison de lieu et jour.
Le comptage de vélos présente des données de séries temporelles que nous visualisons ci-dessous.

<!-- paragraph -->

```{r counterviz}
passages_dt[, lieu.lines := gsub("[- _]", "\n", lieu)]
ggplot()+
  theme_bw()+
  theme(panel.margin=grid::unit(0, "lines"))+
  facet_grid(lieu.lines ~ .)+
  geom_point(aes(
    date, passages, color=passages==0),
    shape=21,
    data=passages_dt)+
  scale_color_manual(values=c("TRUE"="grey", "FALSE"="black"))
```

<!-- paragraph -->

Le graphique ci-dessus données permet de voir facilement la différence entre les zéros (en gris) et les valeurs manquantes.
On voit bien la régularité au fil des saisons (moins de vélos en hiver).

### Accidents

Pour examiner le tableau de données sur les accidents, il faut d'abord convertir certaines variables en unicode :

<!-- paragraph -->

```{r accidents}
library(animint2)
data(montreal.bikes) #only present if installed from github
for(col_name in c("nom","nom_comptage","Etat")){
  montreal.bikes$counter.locations[[col_name]] <- iconv(
    montreal.bikes$counter.locations[[col_name]], "latin1", "UTF-8")
}
```

Ensuite nous affichons une ligne :

```{r}
montreal.bikes$accidents[1,]
```

<!-- paragraph -->

Pour chaque accident il y a des données sur la date, l'heure, la localisation et le nombre de morts et de blessés.
<!-- comment -->
Certaines valeurs sont en français (par exemple : `Voie de circulation`, `En intersection`, etc).
<!-- comment -->
Pour les colonnes avec noms en anglais, nous allons faire des copies en français :

<!-- paragraph -->

```{r}
gravité <- c(
  décès="deaths",
  blessures.graves="people.severely.injured",
  blessures.mineures="people.slightly.injured")
montreal.bikes$accidents[, names(gravité)] <-
  montreal.bikes$accidents[, gravité]
accidents_dt <- data.table(montreal.bikes$accidents[, c(
  "date.str", "time.str", names(gravité),
  "street", "street.number", "cross.street")])
```

<!-- paragraph -->

Dans le code ci-dessous, nous rajoutons une colonne pour le mois.

<!-- paragraph -->

```{r timeRange}
ymd2POSIXct <- function(date.str){
  as.POSIXct(strptime(date.str, "%Y-%m-%d"))
}
(accidents_dt[
, date.POSIXct := ymd2POSIXct(date.str)
][
, mois.str := mois(date.POSIXct)
][])
```

<!-- paragraph -->

Dans la sortie ci-dessus, on voit que les derniers mois pour les accidents ne sont pas les mêmes que les compteurs. On compare les intervalles dans le code ci-dessous :

```{r}
data.list <- list(accidents=accidents_dt, passages=passages_dt)
sapply(data.list, function(DT)range(DT$mois.str))
```

Dans la sortie ci-dessus, on voit que les passages et les accidents se chevauchent.
Nous allons compiler des résumés pour tous les mois, c'est pourquoi nous faisons un tableau de données pour chaque mois ci-dessous.

<!-- paragraph -->

```{r months}
uniq.mois.vec <- sort(unique(unlist(lapply(
  data.list, function(DT)DT$mois.str))))
mois2POSIXct <- function(mois, jour="01"){
  ymd2POSIXct(paste0(mois, "-", jour))
}
mois_dt <- data.table(mois01 = mois2POSIXct(uniq.mois.vec))
```

Le code ci-dessous définit l'environnement linguistique (locale) pour avoir les noms de mois en français.

```{r}
old.locale <- Sys.setlocale(locale="fr_CA.UTF-8")
mois_français_str <- function(POSIXct)strftime(POSIXct, "%B %Y")
mois.levs <- mois_français_str(mois_dt$mois01)
mois_français <- function(POSIXct)factor(
  mois_français_str(POSIXct), mois.levs)
mois_dt[, mois.français := mois_français(mois01)][]
```

<!-- paragraph -->

La sortie ci-dessus comprend une ligne pour chaque mois.
<!-- comment -->
Notez que nous avons créé une colonne `mois.français` de type `factor`, avec niveaux `mois.levs` qui définit l'ordre d'affichage.
Dans le code ci-dessous, nous calculons la somme des accidents par mois.

```{r}
(accidents.par.mois <- dcast(
  accidents_dt,
  mois.str ~ .,
  sum,
  value.var=names(gravité)))
```

Ci-dessus on voit une ligne pour chaque mois, avec différentes colonnes pour chaque niveau de gravité.
Nous convertissons ces colonnes en lignes avec le code ci-dessous :

```{r}
(accidents.tall <- melt(
  accidents.par.mois,
  measure.vars=names(gravité),
  variable.name="gravité",
  value.name="personnes"))
```

Ci-dessus on voit une ligne pour chaque combinaison de mois et gravité.
Dans le code ci-dessous, nous utilisons ces données pour créer un graphique montrant le nombre d'accidents par mois.

<!-- paragraph -->

```{r accidentsPerMonth}
gravité.colors <- c(
  blessures.mineures="#FEE0D2",#lite red
  blessures.graves="#FB6A4A",
  décès="#A50F15")#dark red
ggplot()+
  theme_bw()+
  geom_bar(aes(
    mois2POSIXct(mois.str), personnes, fill=gravité),
    stat="identity",
    data=accidents.tall)+
  scale_fill_manual(values=gravité.colors)+
  scale_x_datetime("mois")
```

Ci-dessus, on voit le nombre de personnes décédées et blessées au fil du temps.

## Visualisation interactive de la fréquence des accidents {#regression}

Maintenant nous voulons comparer, pour chaque mois, les données de compteurs et d'accidents.
Est-ce que nous avons plus d'accidents quand il y a plus de passages en vélo ?
Pour vérifier, nous devons calculer un résumé des passages par mois avec le code ci-dessous.

```{r}
(passages.par.mois <- dcast(
  passages_dt[!is.na(passages)],
  lieu + mois.str ~ .,
  list(length, mean, sum),
  value.var="passages"))
```

La sortie ci-dessus contient une ligne pour chaque combinaison de lieu et mois, avec des colonnes pour:

* `passages_length` : le nombre de jours.
* `passages_mean` : le moyenne de passages par jour.
* `passages_sum` : le total nombre de passages.

On remarque que certains mois comportent des journées manquantes. Par exemple, il n'y a que 29 jours pour `Berri` en avril 2009, et 18 jours pour `Totem_Laurier` en septembre 2013.
Pour modeliser seulement les mois entiers, nous voulons enlever les mois avec jours manquants.
Alors on utiliser le code ci-dessous pour calculer le nombre de jours dans chaque mois :

```{r}
un.jour <- 60 * 60 * 24
mois_suivant <- function(POSIXct){
  mois2POSIXct(POSIXct + un.jour * 31)
}
passages.par.mois[, jours.dans.mois := as.integer(round(difftime(
  mois2POSIXct(mois(mois_suivant(mois2POSIXct(mois.str)))),
  mois2POSIXct(mois.str),
  units="days"
)))][]
```

Dans la sortie ci-dessus, on voit la nouvelle colonne `jours.dans.mois`.
Avec le code ci-dessous, on affiche seulement les mois avec jours manquants :

```{r}
passages.par.mois[
  passages_length < jours.dans.mois,
  .(lieu, mois.str, passages_length, jours.dans.mois)]
```

Nous allons exclure les données ci-dessus, en utilisant le code ci-dessous :

```{r}
mois.complets <- passages.par.mois[passages_length == jours.dans.mois]
```

Ensuite, nous faisons un tableau avec les passages et les accidents dans différents colonnes :

```{r}
city.wide.complete <- mois.complets[passages_sum>0, .(
  lieux=.N,
  total.passages=sum(passages_sum)
), keyby=mois.str]
city.wide.accidents <- accidents_dt[, .(
  total.accidents=.N
), keyby=mois.str]
(scatter.not.na <- city.wide.accidents[
  city.wide.complete, nomatch=0L
][, mois01 := mois2POSIXct(mois.str)][])
```

Dans la sortie ci-dessus, on voit une ligne pour chaque mois avec les données de compteurs et accidents.
Ensuite, nous faisons un modèle linéaire pour prédire les accidents à partir des passages :

```{r}
(fit <- lm(total.accidents ~ total.passages - 1, scatter.not.na))
scatter.not.na[, mean(total.accidents/total.passages)]
scatter.not.na[, sum(total.accidents)/sum(total.passages)]
```

Dans la sortie ci-dessus, on voit que le coefficient du modèle est proche des moyennes empiriques.
Enfin, nous faisons un graphique interactif avec le code ci-dessous.

```{r Ch09-viz-regression}
scatter.not.na[, let(
  pred.accidents = predict(fit),
  mois.français = mois_français(mois01)
)]
animint(
  regression=ggplot()+
    theme_bw()+
    ggtitle("Accidents et passages par mois")+
    geom_line(aes(
      total.passages, pred.accidents),
      color="grey",
      data=scatter.not.na)+
    geom_point(aes(
      total.passages, total.accidents),
      shape=1,
      clickSelects="mois.français",
      size=5,
      alpha=0.75,
      data=scatter.not.na)+
    ylab("Accidents par mois")+
    xlab("Passages par mois"),
  timeSeries=ggplot()+
    theme_bw()+
    ggtitle("Série temporelle de la fréquence des accidents")+
    xlab("mois")+
    geom_point(aes(
      mois01, total.accidents/total.passages),
      clickSelects="mois.français",
      size=5,
      alpha=0.75,
      data=scatter.not.na))
```

La visualisation des données ci-dessus contient deux graphiques réliés.
<!-- comment -->
Le graphique de gauche montre que le nombre d'accidents augmente avec le nombre de cyclistes.
<!-- comment -->
Le graphique de droite montre la fréquence des accidents au fil du temps.

<!-- paragraph -->

## Visualisation interactive avec carte et détails {#details}

<!-- paragraph -->

Dans cette partie, nous allons faire une visualisation avec plusieurs composants :

* Résumé des compteurs : plan des compteurs ou min/max des mois pour chaque compteur, pour sélectionner un compteur.
* Détails d'un compteur, résumé des mois : séries temporelles par mois, pour les accidents et les données d'un compteur. Cliquer pour sélectionner un mois.
* Détails d'un compteur et d'un mois : séries temporelles par jour, pour le mois sélectionné (les accidents, et le compteur sélectionné).

### Résumé des compteurs avec plan

Les données `counter.locations` contient l'emplacement géographique de chaque compteur.

```{r}
(counter.locations <- data.table(montreal.bikes$counter.locations)[, let(
  lon = coord_X,
  lat = coord_Y
)][])
```

Dans la sortie ci-dessus, on voit qu'il y a les colonnes `nom` et `nom_comptage` qui indiquent les lieux, mais ce ne sont pas exactement les mêmes valeurs que dans les données de passages.
On utilise le code ci-dessous pour établir une correspondence entre les tableaux :

```{r}
loc.name.code <- c(
  Berri1="Berri",
  Brebeuf="Brébeuf",
  CSC="Côte-Sainte-Catherine",
  Maisonneuve_1="Maisonneuve 1",
  Maisonneuve_2="Maisonneuve 2",
  Parc="du Parc",
  PierDup="Pierre-Dupuy",
  "Rachel/Papineau"="Rachel",
  "Saint-Urbain"="Saint-Urbain",
  Totem_Laurier="Totem_Laurier")
show.locations <- counter.locations[
, lieu := loc.name.code[nom_comptage]
][!is.na(lieu)]
```

<!-- paragraph -->

L'emplacement des compteurs est tracé ci-dessous.
<!-- comment -->
Notez que nous utilisons `clickSelects=lieu`.

<!-- paragraph -->

```{r}
map.lim <- show.locations[, list(
  range.lat=range(lat),
  range.lon=range(lon)
)]
diff.vec <- sapply(map.lim, diff)
diff.mat <- c(-1, 1) * matrix(diff.vec, 2, 2, byrow=TRUE)
scale.mat <- as.matrix(map.lim) + diff.mat
counts.per.month.loc <- passages.par.mois[show.locations, on="lieu"]
bike.paths <- data.table(montreal.bikes$path.locations)
some.paths <- bike.paths[
  scale.mat[1, "range.lat"] < lat &
    scale.mat[1, "range.lon"] < lon &
    lat < scale.mat[2, "range.lat"] &
    lon < scale.mat[2, "range.lon"]]
(mtl.map <- ggplot()+
  theme_bw()+
  theme(
    panel.margin=grid::unit(0, "lines"),
    axis.line=element_blank(), axis.text=element_blank(), 
    axis.ticks=element_blank(), axis.title=element_blank(),
    panel.background = element_blank(),
    panel.border = element_blank())+
  coord_equal(xlim=map.lim$range.lon, ylim=map.lim$range.lat)+
  scale_x_continuous(limits=scale.mat[, "range.lon"])+
  scale_y_continuous(limits=scale.mat[, "range.lat"])+
  geom_path(aes(
    lon, lat,
    tooltip=TYPE_VOIE,
    group=paste(feature.i, path.i)),
    color="grey",
    data=some.paths)+
  guides(color="none")+
  geom_text(aes(
    lon, lat,
    label=lieu),
    clickSelects="lieu",
    data=show.locations))
```

La sortie ci-dessus est un plan de Montréal, avec texte pour chacun des dix compteurs.

### Résumé des dates extrêmes pour chaque compteur

Maintenant on calcule les dates extrêmes pour chaque compteur :

```{r}
(location.ranges <- dcast(
  passages.par.mois[0 < passages_sum][
  , mois01 := mois2POSIXct(mois.str)],
  lieu ~ .,
  list(min, max),
  value.var="mois01"))
```

Dans la sortie ci-dessus, on voit une ligne pour chaque compteur, avec des colonnes pour les dates extrêmes.
Le graphique ci-dessous montre la période pendant laquelle chaque compteur a fonctionné.

```{r}
location.colors <- c(#dput(RColorBrewer::brewer.pal(12, "Set3"))
  "#8DD3C7", "#FFFFB3", "#BEBADA", "#FB8072", "#80B1D3", "#FDB462", 
  "#B3DE69", "#FCCDE5", "#D9D9D9", "#BC80BD", "#CCEBC5", "#FFED6F")
names(location.colors) <- show.locations$lieu
seg.size <- 10
(CounterRanges <- ggplot()+
  theme_bw()+
  theme_animint(width=450, height=250)+
  xlab("min/max dates")+
  ylab("source des données")+
  scale_color_manual(values=location.colors)+
  guides(color="none")+
  geom_segment(aes(
    mois01_min, lieu,
    xend=mois01_max, yend=lieu,
    color=lieu),
    clickSelects="lieu",
    data=location.ranges, alpha=3/4, size=seg.size))
```

La sortie ci-dessus contient un segment pour chaque compteur.
Avec le code ci-dessous, nous rajoutons un segment pour les accidents.

```{r}
accidents.range <- dcast(
  data.table(lieu="accidents", accidents_dt),
  lieu ~ .,
  list(min, max),
  value.var="date.POSIXct")
(MonthSummary <- CounterRanges+
  geom_segment(aes(
    date.POSIXct_min, lieu,
    xend=date.POSIXct_max, yend=lieu),
    color=gravité.colors[["décès"]],
    data=accidents.range,
    size=seg.size))
```

Dans la sortie ci-dessus, on voit un segment de plus (pour les accidents en bas).

### Séries temporelles par mois

Le graphique ci-dessous présente le comptage de vélos à chaque localisation, chaque jour.

```{r}
ggplot()+
  theme_bw()+
  geom_line(aes(
    date, passages, group=lieu),
    data=passages_dt)+
  scale_color_manual(values=location.colors)+
  geom_point(aes(
    date, passages, color=lieu),
    data=passages_dt)
```

<!-- paragraph -->

Le graphique ci-dessous reprend les mêmes données mais pour chaque mois.

<!-- paragraph -->

```{r}
mois.text <- passages.par.mois[
, .SD[which.max(passages_sum)]
, by=lieu]
FACET <- function(DT, facet)data.table(DT, facet)
COMPTEURS <- function(DT)FACET(DT, "mean cyclists per day")
(MonthSeries <- ggplot()+
  guides(color="none", fill="none")+
  theme_bw()+
  facet_grid(facet ~ ., scales="free")+
  geom_tallrect(aes(
    xmin=mois01, xmax=mois2POSIXct(mois(mois_suivant(mois01)))),
    clickSelects="mois.français",    
    data=COMPTEURS(mois_dt),
    alpha=1/2)+
  geom_line(aes(
    mois2POSIXct(mois.str), passages_sum, group=lieu,
    color=lieu),
    showSelected="lieu",
    clickSelects="lieu",
    data=COMPTEURS(passages.par.mois))+
  scale_color_manual(values=location.colors)+
  scale_fill_manual(values=location.colors)+
  xlab("month")+
  ylab("bike counts per month"))
```

Le graphique ci-dessus contient une ligne pour chaque compteur.
Dans le code ci-dessous, on rajoute deux geoms.

```{r}
(MonthText <- MonthSeries+
  geom_point(aes(
    mois2POSIXct(mois.str), passages_sum, fill=lieu,
    tooltip=paste(
      passages_sum, "vélos à",
      lieu, "en", mois_français(mois2POSIXct(mois.str)))),
    showSelected="lieu",
    clickSelects="lieu",
    size=5,
    color="black",
    data=COMPTEURS(passages.par.mois))+
  geom_text(aes(
    mois2POSIXct(mois.str), passages_sum+5000,
    color=lieu, label=lieu),
    showSelected="lieu",
    clickSelects="lieu",
    data=COMPTEURS(mois.text)))
```

Le graphique ci-dessous TODO

```{r}
accidents.title <- "city-wide accidents"
(city.wide.cyclists <- passages.par.mois[, .(
  lieux=.N,
  passages=sum(passages_sum)
), by=mois15][])
MonthFacet <- ggplot()+
  ggtitle("All data, select month")+
  guides(color="none", fill="none")+
  theme_bw()+
  facet_grid(facet ~ ., scales="free")+
  theme(panel.margin=grid::unit(0, "lines"))+
  geom_tallrect(aes(
    xmin=month01.POSIXct, xmax=next01.POSIXct),
    clickSelects="month",
    data=data.table(
      city.wide.cyclists,
      facet=counter.title),
    alpha=1/2)+
  geom_line(aes(
    month.POSIXct, mean.per.day, group=location,
    color=location),
    showSelected="location",
    clickSelects="location",
    data=data.table(counts.per.month, facet=counter.title))+
  scale_color_manual(values=location.colors)+
  xlab("month")+
  ylab("")+
  geom_point(aes(
    month.POSIXct, mean.per.day, color=location,
    tooltip=paste(
      count, "cyclists counted at",
      location, "in",
      days, "days of", month,
      sprintf("(mean %d cyclists/day)", as.integer(mean.per.day)))),
    showSelected="location",
    clickSelects="location",
    size=5,
    fill="grey",
    data=data.table(counts.per.month, facet=counter.title))+
  geom_text(aes(
    month.POSIXct, mean.per.day+300, color=location, label=location),
    showSelected="location",
    clickSelects="location",
    data=data.table(month.labels, facet=counter.title))+
  scale_fill_manual(values=severity.colors, breaks=names(severity.colors))+
  geom_bar(aes(
    month.POSIXct, people,
    fill=severity),
    showSelected="severity",
    stat="identity",
    position="identity",
    color=NA,
    data=data.table(accidents.tall, facet=accidents.title))+
  geom_tallrect(aes(
    xmin=month01.POSIXct, xmax=next01.POSIXct,
    tooltip=paste(
      ifelse(deaths==0, "",
      ifelse(deaths==1,
             "1 death,",
             paste(deaths, "deaths,"))),
      ifelse(people.severely.injured==0, "",
      ifelse(people.severely.injured==1,
             "1 person severely injured,",
             paste(people.severely.injured,
                   "people severely injured,"))),
      people.slightly.injured,
      "people slightly injured in",
      month)),
    clickSelects="month",
    alpha=0.5,
    data=data.table(accidents.per.month,
                    facet=accidents.title))
MonthFacet
```

<!-- paragraph -->

### Détails pour un mois

Le graphique ci-dessous est un dotplot des accidents pour chaque mois.
<!-- comment -->
Chaque point représente une personne qui a eu un accident.

<!-- paragraph -->

Ci-dessous, nous classons la gravité de chaque accident en fonction du résultat le plus grave pour les personnes touchées.

<!-- paragraph -->

```{r}
accidents_dt[, gravité.str := fcase(
  0 < décès, "décès",
  0 < blessures.graves, "blessures.graves",
  default="blessures.mineures"
)][
, gravité := factor(gravité.str, names(gravité.colors))
][, table(gravité)]
```

<!-- paragraph -->

Le résultat ci-dessus montre que les accidents avec des blessures mineures sont les plus fréquents et que les accidents avec au moins un décès sont les moins fréquents.
<!-- comment -->

```{r}
jour_du_mois <- function(POSIXct)as.integer(strftime(POSIXct, "%d"))
(accidents.cumsum <- accidents_dt[
  order(date.POSIXct, month, severity)
][
, accident.i := seq_along(severity)
, by=.(date.POSIXct, month)
][
, day.of.the.month := as.integer(strftime(date.POSIXct, "%d"))
][])
ggplot()+
  theme_bw()+
  theme(panel.margin=grid::unit(0, "cm"))+
  facet_wrap("month")+
  geom_text(aes(15, 25, label=month), data=accidents.per.month)+
  scale_fill_manual(values=severity.colors)+
  scale_x_continuous("day of the month", breaks=c(1, 10, 20, 30))+
  geom_point(aes(
    day.of.the.month, accident.i, fill=severity),
    shape=21,
    data=accidents.cumsum)
```

<!-- paragraph -->


```{r}
(days.dt <- data.table(
  day.POSIXct=with(months, seq(
    min(month01.POSIXct),
    max(next01.POSIXct),
    by="day"))
)[
, day.of.the.week := strftime(day.POSIXct, "%a")
][])
## The following only works in locales with English days of the week.
(weekend.dt <- days.dt[
  day.of.the.week %in% c("Sat", "Sun")
][, let(
  month.text = strftime(day.POSIXct, "%B %Y"),
  day.of.the.month = as.integer(strftime(day.POSIXct, "%d"))
)][
, month := factor(month.text, month.levs)
][])
counter.title <- "cyclists per day"
jour.text <- passages_dt[, .SD[which.max(passages)], by=.(location, mois15)]
DaysFacet <- ggplot()+
  ggtitle("Selected month (weekends in grey)")+
  geom_tallrect(aes(
    xmin=day.of.the.month-0.5, xmax=day.of.the.month+0.5,
    key=paste(day.POSIXct)),
    showSelected="month",
    fill="grey",
    color="white",
    data=weekend.dt)+
  guides(color="none")+
  theme_bw()+
  facet_grid(facet ~ ., scales="free")+
  geom_line(aes(
    day.of.the.month, count, group=location,
    key=location,
    color=location),
    showSelected=c("location", "month"),
    clickSelects="location",
    chunk_vars=c("month"),
    data=data.table(passages_dt, facet=counter.title))+
  scale_color_manual(values=location.colors)+
  ylab("")+
  geom_point(aes(
    day.of.the.month, count, color=location,
    key=paste(day.of.the.month, location),
    tooltip=paste(
      count, "cyclists counted at",
      location, "on",
      date)),
    showSelected=c("location", "month"),
    clickSelects="location",
    size=5,
    chunk_vars=c("month"),
    fill="white",
    data=data.table(passages_dt, facet=counter.title))+
  scale_fill_manual(values=severity.colors, breaks=names(severity.colors))+
  geom_text(aes(
    15, 23, label=month, key=1),
    showSelected="month",
    data=data.table(months, facet=accidents.title))+
  scale_x_continuous("day of the month", breaks=c(1, 10, 20, 30))+
  geom_text(aes(
    day.of.the.month, count+500, color=location, label=location,
    key=location),
    showSelected=c("location", "month"),
    clickSelects="location",
    data=data.table(day.labels, facet=counter.title))+
  geom_point(aes(
    day.of.the.month, accident.i,
    key=paste(date.str, accident.i),
    tooltip=paste(
      ifelse(deaths==0, "",
      ifelse(deaths==1,
             "1 death,",
             paste(deaths, "deaths,"))),
      ifelse(people.severely.injured==0, "",
      ifelse(people.severely.injured==1,
             "1 person severely injured,",
             paste(people.severely.injured,
                   "people severely injured,"))),
      people.slightly.injured,
      "people slightly injured at",
      ifelse(is.na(street.number), "", street.number),
      street, "/", cross.street,
      date.str, time.str),
    fill=severity),
    showSelected="month",
    size=4,
    chunk_vars=c("month"),
    data=data.table(accidents.cumsum, facet=accidents.title))
DaysFacet
```

<!-- paragraph -->

```{r Ch09-viz-mtl}
animint(
  MonthFacet,
  DaysFacet,
  MonthSummary,
  selector.types=list(severity="multiple"),
  duration=list(month=2000),
  first=list(
    location="Berri",
    month="September 2012"),
  time=list(variable="month", ms=5000))#buggy.
```

<!-- paragraph -->

## Résumé du chapitre et exercices {#exercises}

<!-- paragraph -->

Exercices :

<!-- paragraph -->

- Modifiez la localisation à une variable de sélection multiple.
<!-- comment -->
- Ajoutez un graphique pour la carte à la visualisation des données.
<!-- comment -->
- Sur la carte, dessinez un cercle pour chaque localisation, dont la taille varie en fonction du comptage `count` des accidents dans le mois `month` sélectionné.
<!-- comment -->
- Sur le graphique `MonthSummary`, ajoutez un rectangle en arrière-plan qui peut être utilisé pour sélectionner le mois `month`.
<!-- comment -->
- Supprimez le graphique `MonthSummary` et ajoutez une visualisation similaire dans un troisième panneau de l'écran dans le graphique `MonthFacet`.

<!-- paragraph -->

Dans le [chapitre 10](Ch10-nearest-neighbors.html), nous vous expliquerons comment visualiser le modèle d'apprentissage automatique des K-voisins les plus proches.

<!-- paragraph -->



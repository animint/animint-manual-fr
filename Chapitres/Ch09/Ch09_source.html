<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Montreal bikes data viz</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Ch09_source_files/libs/clipboard/clipboard.min.js"></script>
<script src="Ch09_source_files/libs/quarto-html/quarto.js"></script>
<script src="Ch09_source_files/libs/quarto-html/popper.min.js"></script>
<script src="Ch09_source_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Ch09_source_files/libs/quarto-html/anchor.min.js"></script>
<link href="Ch09_source_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Ch09_source_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Ch09_source_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Ch09_source_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Ch09_source_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Montreal bikes data viz</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- paragraph -->
<section id="chapter-9-montreal-bikes-data-viz" class="level1">
<h1>Chapter 9, Montreal bikes data viz</h1>
<!-- paragraph -->
<!-- paragraph -->
<p>In this chapter we will explore several data visualizations of the Montreal bike data set.</p>
<!-- paragraph -->
<p>Chapter outline:</p>
<!-- paragraph -->
<ul>
<li>We begin with some static data visualizations. <!-- comment --></li>
<li>We create an interactive visualization of accident frequency over time. <!-- comment --></li>
<li>We create a interactive data viz with four plots, showing monthly accident trends, daily details, and a map of counter locations.</li>
</ul>
<!-- paragraph -->
<section id="static" class="level2">
<h2 class="anchored" data-anchor-id="static">Static figures</h2>
<!-- paragraph -->
<p>We begin by loading the <code>montreal.bikes</code> data set, which is not available in the CRAN release of animint2, in order to save space on CRAN. <!-- comment --> Therefore to access this data set, you will need to install animint2 from GitHub:</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data</span>(montreal.bikes, <span class="at">package=</span><span class="st">"animint2"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>}, <span class="at">warning=</span><span class="cf">function</span>(w){</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"tdhock/animint2"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- paragraph -->
<p>We begin by examining the accidents data table.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(animint2)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(montreal.bikes) <span class="co">#only present if installed from github</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setlocale</span>(<span class="at">locale=</span><span class="st">"en_US.UTF-8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "LC_COLLATE=en_US.UTF-8;LC_CTYPE=en_US.UTF-8;LC_MONETARY=en_US.UTF-8;LC_NUMERIC=C;LC_TIME=en_US.UTF-8"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span> <span class="st">"Brébeuf"</span> <span class="sc">%in%</span> montreal.bikes<span class="sc">$</span>counter.counts<span class="sc">$</span>location){</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Encoding</span>(<span class="fu">levels</span>(montreal.bikes<span class="sc">$</span>counter.counts<span class="sc">$</span>location)) <span class="ot">&lt;-</span> <span class="st">"UTF-8"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">table</span>(montreal.bikes<span class="sc">$</span>counter.counts<span class="sc">$</span>location))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'data.table' was built under R version 4.5.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>accidents.dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(montreal.bikes<span class="sc">$</span>accidents)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(accidents.dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Classes 'data.table' and 'data.frame':  5595 obs. of  12 variables:
 $ date.str               : chr  "2012-01-02" "2012-01-05" "2012-01-09" "2012-01-10" ...
 $ time.str               : chr  "18:35" "21:50" "21:15" "15:40" ...
 $ deaths                 : int  0 0 0 0 0 0 0 1 0 0 ...
 $ people.severely.injured: int  0 0 0 0 0 0 0 0 0 0 ...
 $ people.slightly.injured: int  1 1 1 1 1 1 1 0 1 1 ...
 $ street.number          : int  NA NA NA NA NA 2330 NA NA 4160 NA ...
 $ street                 : chr  "ST JEAN BAPTISTE O" "FOSTER" "ROSEMONT" "ST ANTOINE" ...
 $ cross.street           : chr  "AV ROULEAU" "JANELLE" "DES ERABLES" "MANSFIELD" ...
 $ location.int           : int  32 34 NA 32 32 34 32 32 33 31 ...
 $ position.int           : int  6 6 6 6 6 6 6 6 6 5 ...
 $ position               : chr  "Voie de circulation" "Voie de circulation" "Voie de circulation" "Voie de circulation" ...
 $ location               : chr  "En intersection (moins de 5 mètres)" "Entre intersections (100 mètres et +)" NA "En intersection (moins de 5 mètres)" ...
 - attr(*, ".internal.selfref")=&lt;externalptr&gt; </code></pre>
</div>
</div>
<!-- paragraph -->
<p>Each accident has data about its date, time, location, and counts of death and slight/severe injury. <!-- comment --> Some of the values are in French (e.g.&nbsp;position Voie de circulation, location En intersection, etc).</p>
<!-- paragraph -->
<p>We calculate the time period of the accidents below.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(accidents.dt[</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>, <span class="at">date.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(date.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>, <span class="at">month.str :=</span> <span class="fu">strftime</span>(date.POSIXct, <span class="st">"%Y-%m"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date.str time.str deaths people.severely.injured
          &lt;char&gt;   &lt;char&gt;  &lt;int&gt;                   &lt;int&gt;
   1: 2012-01-02    18:35      0                       0
   2: 2012-01-05    21:50      0                       0
   3: 2012-01-09    21:15      0                       0
   4: 2012-01-10    15:40      0                       0
   5: 2012-01-10     0:15      0                       0
  ---                                                   
5591: 2014-12-19    12:22      0                       0
5592: 2014-12-19    19:50      0                       0
5593: 2014-12-26    19:56      0                       0
5594: 2014-12-27    12:35      0                       0
5595: 2014-12-30    11:55      0                       0
      people.slightly.injured street.number             street   cross.street
                        &lt;int&gt;         &lt;int&gt;             &lt;char&gt;         &lt;char&gt;
   1:                       1            NA ST JEAN BAPTISTE O     AV ROULEAU
   2:                       1            NA             FOSTER        JANELLE
   3:                       1            NA           ROSEMONT    DES ERABLES
   4:                       1            NA         ST ANTOINE      MANSFIELD
   5:                       1            NA         TASCHEREAU         ANGELE
  ---                                                                        
5591:                       1            NA    COTE DES NEIGES       DES PINS
5592:                       1            NA      BOUTHILLIER N      FRONTENAC
5593:                       1            NA  BD DU SEMINAIRE N     ST GEORGES
5594:                       1            NA   CH DES PATRIOTES        1RE RUE
5595:                       1         14965     PIERREFONDS BD JACQUES BIZARD
      location.int position.int                          position
             &lt;int&gt;        &lt;int&gt;                            &lt;char&gt;
   1:           32            6               Voie de circulation
   2:           34            6               Voie de circulation
   3:           NA            6               Voie de circulation
   4:           32            6               Voie de circulation
   5:           32            6               Voie de circulation
  ---                                                            
5591:           32            6               Voie de circulation
5592:           32           NA                              &lt;NA&gt;
5593:           32            8       Terre-plein central ou îlot
5594:           33            6               Voie de circulation
5595:           33            5 Voie cyclable / chaussée désignée
                                         location date.POSIXct month.str
                                           &lt;char&gt;       &lt;POSc&gt;    &lt;char&gt;
   1:         En intersection (moins de 5 mètres)   2012-01-02   2012-01
   2:       Entre intersections (100 mètres et +)   2012-01-05   2012-01
   3:                                        &lt;NA&gt;   2012-01-09   2012-01
   4:         En intersection (moins de 5 mètres)   2012-01-10   2012-01
   5:         En intersection (moins de 5 mètres)   2012-01-10   2012-01
  ---                                                                   
5591:         En intersection (moins de 5 mètres)   2014-12-19   2014-12
5592:         En intersection (moins de 5 mètres)   2014-12-19   2014-12
5593:         En intersection (moins de 5 mètres)   2014-12-26   2014-12
5594: Près d'une intersection/carrefour giratoire   2014-12-27   2014-12
5595: Près d'une intersection/carrefour giratoire   2014-12-30   2014-12</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(accidents.dt<span class="sc">$</span>month.str)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2012-01" "2014-12"</code></pre>
</div>
</div>
<!-- paragraph -->
<p>Below we also compute the range of months for the bike counter data table.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(counts.dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(montreal.bikes<span class="sc">$</span>counter.counts))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            location       date count
              &lt;fctr&gt;     &lt;POSc&gt; &lt;int&gt;
    1:         Berri 2009-01-01    29
    2:         Berri 2009-01-02    19
    3:         Berri 2009-01-03    24
    4:         Berri 2009-01-04    24
    5:         Berri 2009-01-05   120
   ---                               
13379: Totem_Laurier 2013-09-14  2456
13380: Totem_Laurier 2013-09-15  2527
13381: Totem_Laurier 2013-09-16  3012
13382: Totem_Laurier 2013-09-17  3745
13383: Totem_Laurier 2013-09-18  3921</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>counts.dt[, month.str <span class="sc">:</span><span class="er">=</span> <span class="fu">strftime</span>(date, <span class="st">"%Y-%m"</span>)]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(counts.dt<span class="sc">$</span>month.str)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2009-01" "2013-09"</code></pre>
</div>
</div>
<!-- paragraph -->
<p>The bike counts are time series data which we visualize below.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>counts.dt[, loc.lines <span class="sc">:</span><span class="er">=</span> <span class="fu">gsub</span>(<span class="st">"[- _]"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, location)]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.margin=</span>grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>))<span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(loc.lines <span class="sc">~</span> .)<span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    date, count, <span class="at">color=</span>count<span class="sc">==</span><span class="dv">0</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape=</span><span class="dv">21</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>counts.dt)<span class="sc">+</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"TRUE"</span><span class="ot">=</span><span class="st">"grey"</span>, <span class="st">"FALSE"</span><span class="ot">=</span><span class="st">"black"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 407 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/counterviz-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<p>Plotting with <code>geom_point</code> makes it easy to see the difference between zeros and missing values.</p>
<!-- paragraph -->
<p>We will compute a summary of all accidents per month in this time period, so we first create a data table for each month below. <!-- comment --> (and make sure to set the locale to C for English month names)</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>uniq.month.vec <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  accidents.dt<span class="sc">$</span>month.str,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  counts.dt<span class="sc">$</span>month.str))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>one.day <span class="ot">&lt;-</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">60</span> <span class="sc">*</span> <span class="dv">24</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">month.str=</span>uniq.month.vec)[</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>, month01.str <span class="sc">:</span><span class="er">=</span> <span class="fu">paste0</span>(month.str, <span class="st">"-01"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>, month01.POSIXct <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(month01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>][, <span class="fu">let</span>(</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">next.POSIXct =</span> month01.POSIXct <span class="sc">+</span> one.day <span class="sc">*</span> <span class="dv">31</span>,</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">month.str =</span> <span class="fu">strftime</span>(month01.POSIXct, <span class="st">"%B %Y"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>)][</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>, next01.str <span class="sc">:</span><span class="er">=</span> <span class="fu">paste0</span>(<span class="fu">strftime</span>(next.POSIXct, <span class="st">"%Y-%m"</span>), <span class="st">"-01"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>, next01.POSIXct <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(next01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>month.levs <span class="ot">&lt;-</span> months[<span class="fu">order</span>(month01.POSIXct), month.str]</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>(months[, <span class="at">month :=</span> <span class="fu">factor</span>(month.str, month.levs)][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         month.str month01.str month01.POSIXct        next.POSIXct next01.str
            &lt;char&gt;      &lt;char&gt;          &lt;POSc&gt;              &lt;POSc&gt;     &lt;char&gt;
 1:   January 2012  2012-01-01      2012-01-01 2012-02-01 00:00:00 2012-02-01
 2:  February 2012  2012-02-01      2012-02-01 2012-03-03 00:00:00 2012-03-01
 3:     March 2012  2012-03-01      2012-03-01 2012-04-01 01:00:00 2012-04-01
 4:     April 2012  2012-04-01      2012-04-01 2012-05-02 00:00:00 2012-05-01
 5:       May 2012  2012-05-01      2012-05-01 2012-06-01 00:00:00 2012-06-01
 6:      June 2012  2012-06-01      2012-06-01 2012-07-02 00:00:00 2012-07-01
 7:      July 2012  2012-07-01      2012-07-01 2012-08-01 00:00:00 2012-08-01
 8:    August 2012  2012-08-01      2012-08-01 2012-09-01 00:00:00 2012-09-01
 9: September 2012  2012-09-01      2012-09-01 2012-10-02 00:00:00 2012-10-01
10:   October 2012  2012-10-01      2012-10-01 2012-11-01 00:00:00 2012-11-01
11:  November 2012  2012-11-01      2012-11-01 2012-12-01 23:00:00 2012-12-01
12:  December 2012  2012-12-01      2012-12-01 2013-01-01 00:00:00 2013-01-01
13:   January 2013  2013-01-01      2013-01-01 2013-02-01 00:00:00 2013-02-01
14:  February 2013  2013-02-01      2013-02-01 2013-03-04 00:00:00 2013-03-01
15:     March 2013  2013-03-01      2013-03-01 2013-04-01 01:00:00 2013-04-01
16:     April 2013  2013-04-01      2013-04-01 2013-05-02 00:00:00 2013-05-01
17:       May 2013  2013-05-01      2013-05-01 2013-06-01 00:00:00 2013-06-01
18:      June 2013  2013-06-01      2013-06-01 2013-07-02 00:00:00 2013-07-01
19:      July 2013  2013-07-01      2013-07-01 2013-08-01 00:00:00 2013-08-01
20:    August 2013  2013-08-01      2013-08-01 2013-09-01 00:00:00 2013-09-01
21: September 2013  2013-09-01      2013-09-01 2013-10-02 00:00:00 2013-10-01
22:   October 2013  2013-10-01      2013-10-01 2013-11-01 00:00:00 2013-11-01
23:  November 2013  2013-11-01      2013-11-01 2013-12-01 23:00:00 2013-12-01
24:  December 2013  2013-12-01      2013-12-01 2014-01-01 00:00:00 2014-01-01
25:   January 2014  2014-01-01      2014-01-01 2014-02-01 00:00:00 2014-02-01
26:  February 2014  2014-02-01      2014-02-01 2014-03-04 00:00:00 2014-03-01
27:     March 2014  2014-03-01      2014-03-01 2014-04-01 01:00:00 2014-04-01
28:     April 2014  2014-04-01      2014-04-01 2014-05-02 00:00:00 2014-05-01
29:       May 2014  2014-05-01      2014-05-01 2014-06-01 00:00:00 2014-06-01
30:      June 2014  2014-06-01      2014-06-01 2014-07-02 00:00:00 2014-07-01
31:      July 2014  2014-07-01      2014-07-01 2014-08-01 00:00:00 2014-08-01
32:    August 2014  2014-08-01      2014-08-01 2014-09-01 00:00:00 2014-09-01
33: September 2014  2014-09-01      2014-09-01 2014-10-02 00:00:00 2014-10-01
34:   October 2014  2014-10-01      2014-10-01 2014-11-01 00:00:00 2014-11-01
35:  November 2014  2014-11-01      2014-11-01 2014-12-01 23:00:00 2014-12-01
36:  December 2014  2014-12-01      2014-12-01 2015-01-01 00:00:00 2015-01-01
37:   January 2009  2009-01-01      2009-01-01 2009-02-01 00:00:00 2009-02-01
38:  February 2009  2009-02-01      2009-02-01 2009-03-04 00:00:00 2009-03-01
39:     March 2009  2009-03-01      2009-03-01 2009-04-01 01:00:00 2009-04-01
40:     April 2009  2009-04-01      2009-04-01 2009-05-02 00:00:00 2009-05-01
41:       May 2009  2009-05-01      2009-05-01 2009-06-01 00:00:00 2009-06-01
42:      June 2009  2009-06-01      2009-06-01 2009-07-02 00:00:00 2009-07-01
43:      July 2009  2009-07-01      2009-07-01 2009-08-01 00:00:00 2009-08-01
44:    August 2009  2009-08-01      2009-08-01 2009-09-01 00:00:00 2009-09-01
45: September 2009  2009-09-01      2009-09-01 2009-10-02 00:00:00 2009-10-01
46:   October 2009  2009-10-01      2009-10-01 2009-11-01 00:00:00 2009-11-01
47:  November 2009  2009-11-01      2009-11-01 2009-12-01 23:00:00 2009-12-01
48:  December 2009  2009-12-01      2009-12-01 2010-01-01 00:00:00 2010-01-01
49:   January 2010  2010-01-01      2010-01-01 2010-02-01 00:00:00 2010-02-01
50:  February 2010  2010-02-01      2010-02-01 2010-03-04 00:00:00 2010-03-01
51:     March 2010  2010-03-01      2010-03-01 2010-04-01 01:00:00 2010-04-01
52:     April 2010  2010-04-01      2010-04-01 2010-05-02 00:00:00 2010-05-01
53:       May 2010  2010-05-01      2010-05-01 2010-06-01 00:00:00 2010-06-01
54:      June 2010  2010-06-01      2010-06-01 2010-07-02 00:00:00 2010-07-01
55:      July 2010  2010-07-01      2010-07-01 2010-08-01 00:00:00 2010-08-01
56:    August 2010  2010-08-01      2010-08-01 2010-09-01 00:00:00 2010-09-01
57: September 2010  2010-09-01      2010-09-01 2010-10-02 00:00:00 2010-10-01
58:   October 2010  2010-10-01      2010-10-01 2010-11-01 00:00:00 2010-11-01
59:  November 2010  2010-11-01      2010-11-01 2010-12-01 23:00:00 2010-12-01
60:  December 2010  2010-12-01      2010-12-01 2011-01-01 00:00:00 2011-01-01
61:   January 2011  2011-01-01      2011-01-01 2011-02-01 00:00:00 2011-02-01
62:  February 2011  2011-02-01      2011-02-01 2011-03-04 00:00:00 2011-03-01
63:     March 2011  2011-03-01      2011-03-01 2011-04-01 01:00:00 2011-04-01
64:     April 2011  2011-04-01      2011-04-01 2011-05-02 00:00:00 2011-05-01
65:       May 2011  2011-05-01      2011-05-01 2011-06-01 00:00:00 2011-06-01
66:      June 2011  2011-06-01      2011-06-01 2011-07-02 00:00:00 2011-07-01
67:      July 2011  2011-07-01      2011-07-01 2011-08-01 00:00:00 2011-08-01
68:    August 2011  2011-08-01      2011-08-01 2011-09-01 00:00:00 2011-09-01
69: September 2011  2011-09-01      2011-09-01 2011-10-02 00:00:00 2011-10-01
70:   October 2011  2011-10-01      2011-10-01 2011-11-01 00:00:00 2011-11-01
71:  November 2011  2011-11-01      2011-11-01 2011-12-01 23:00:00 2011-12-01
72:  December 2011  2011-12-01      2011-12-01 2012-01-01 00:00:00 2012-01-01
         month.str month01.str month01.POSIXct        next.POSIXct next01.str
    next01.POSIXct          month
            &lt;POSc&gt;         &lt;fctr&gt;
 1:     2012-02-01   January 2012
 2:     2012-03-01  February 2012
 3:     2012-04-01     March 2012
 4:     2012-05-01     April 2012
 5:     2012-06-01       May 2012
 6:     2012-07-01      June 2012
 7:     2012-08-01      July 2012
 8:     2012-09-01    August 2012
 9:     2012-10-01 September 2012
10:     2012-11-01   October 2012
11:     2012-12-01  November 2012
12:     2013-01-01  December 2012
13:     2013-02-01   January 2013
14:     2013-03-01  February 2013
15:     2013-04-01     March 2013
16:     2013-05-01     April 2013
17:     2013-06-01       May 2013
18:     2013-07-01      June 2013
19:     2013-08-01      July 2013
20:     2013-09-01    August 2013
21:     2013-10-01 September 2013
22:     2013-11-01   October 2013
23:     2013-12-01  November 2013
24:     2014-01-01  December 2013
25:     2014-02-01   January 2014
26:     2014-03-01  February 2014
27:     2014-04-01     March 2014
28:     2014-05-01     April 2014
29:     2014-06-01       May 2014
30:     2014-07-01      June 2014
31:     2014-08-01      July 2014
32:     2014-09-01    August 2014
33:     2014-10-01 September 2014
34:     2014-11-01   October 2014
35:     2014-12-01  November 2014
36:     2015-01-01  December 2014
37:     2009-02-01   January 2009
38:     2009-03-01  February 2009
39:     2009-04-01     March 2009
40:     2009-05-01     April 2009
41:     2009-06-01       May 2009
42:     2009-07-01      June 2009
43:     2009-08-01      July 2009
44:     2009-09-01    August 2009
45:     2009-10-01 September 2009
46:     2009-11-01   October 2009
47:     2009-12-01  November 2009
48:     2010-01-01  December 2009
49:     2010-02-01   January 2010
50:     2010-03-01  February 2010
51:     2010-04-01     March 2010
52:     2010-05-01     April 2010
53:     2010-06-01       May 2010
54:     2010-07-01      June 2010
55:     2010-08-01      July 2010
56:     2010-09-01    August 2010
57:     2010-10-01 September 2010
58:     2010-11-01   October 2010
59:     2010-12-01  November 2010
60:     2011-01-01  December 2010
61:     2011-02-01   January 2011
62:     2011-03-01  February 2011
63:     2011-04-01     March 2011
64:     2011-05-01     April 2011
65:     2011-06-01       May 2011
66:     2011-07-01      June 2011
67:     2011-08-01      July 2011
68:     2011-09-01    August 2011
69:     2011-10-01 September 2011
70:     2011-11-01   October 2011
71:     2011-12-01  November 2011
72:     2012-01-01  December 2011
    next01.POSIXct          month</code></pre>
</div>
</div>
<!-- paragraph -->
<p>Note that we created a <code>month</code> column which is a factor ordered by <code>month.levs</code>.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(accidents.dt[</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>, <span class="at">month.text :=</span> <span class="fu">strftime</span>(date.POSIXct, <span class="st">"%B %Y"</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>, <span class="at">month :=</span> <span class="fu">factor</span>(month.text, month.levs)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>, <span class="at">month.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(<span class="fu">paste0</span>(month.str, <span class="st">"-15"</span>), <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date.str time.str deaths people.severely.injured
          &lt;char&gt;   &lt;char&gt;  &lt;int&gt;                   &lt;int&gt;
   1: 2012-01-02    18:35      0                       0
   2: 2012-01-05    21:50      0                       0
   3: 2012-01-09    21:15      0                       0
   4: 2012-01-10    15:40      0                       0
   5: 2012-01-10     0:15      0                       0
  ---                                                   
5591: 2014-12-19    12:22      0                       0
5592: 2014-12-19    19:50      0                       0
5593: 2014-12-26    19:56      0                       0
5594: 2014-12-27    12:35      0                       0
5595: 2014-12-30    11:55      0                       0
      people.slightly.injured street.number             street   cross.street
                        &lt;int&gt;         &lt;int&gt;             &lt;char&gt;         &lt;char&gt;
   1:                       1            NA ST JEAN BAPTISTE O     AV ROULEAU
   2:                       1            NA             FOSTER        JANELLE
   3:                       1            NA           ROSEMONT    DES ERABLES
   4:                       1            NA         ST ANTOINE      MANSFIELD
   5:                       1            NA         TASCHEREAU         ANGELE
  ---                                                                        
5591:                       1            NA    COTE DES NEIGES       DES PINS
5592:                       1            NA      BOUTHILLIER N      FRONTENAC
5593:                       1            NA  BD DU SEMINAIRE N     ST GEORGES
5594:                       1            NA   CH DES PATRIOTES        1RE RUE
5595:                       1         14965     PIERREFONDS BD JACQUES BIZARD
      location.int position.int                          position
             &lt;int&gt;        &lt;int&gt;                            &lt;char&gt;
   1:           32            6               Voie de circulation
   2:           34            6               Voie de circulation
   3:           NA            6               Voie de circulation
   4:           32            6               Voie de circulation
   5:           32            6               Voie de circulation
  ---                                                            
5591:           32            6               Voie de circulation
5592:           32           NA                              &lt;NA&gt;
5593:           32            8       Terre-plein central ou îlot
5594:           33            6               Voie de circulation
5595:           33            5 Voie cyclable / chaussée désignée
                                         location date.POSIXct month.str
                                           &lt;char&gt;       &lt;POSc&gt;    &lt;char&gt;
   1:         En intersection (moins de 5 mètres)   2012-01-02   2012-01
   2:       Entre intersections (100 mètres et +)   2012-01-05   2012-01
   3:                                        &lt;NA&gt;   2012-01-09   2012-01
   4:         En intersection (moins de 5 mètres)   2012-01-10   2012-01
   5:         En intersection (moins de 5 mètres)   2012-01-10   2012-01
  ---                                                                   
5591:         En intersection (moins de 5 mètres)   2014-12-19   2014-12
5592:         En intersection (moins de 5 mètres)   2014-12-19   2014-12
5593:         En intersection (moins de 5 mètres)   2014-12-26   2014-12
5594: Près d'une intersection/carrefour giratoire   2014-12-27   2014-12
5595: Près d'une intersection/carrefour giratoire   2014-12-30   2014-12
         month.text         month month.POSIXct
             &lt;char&gt;        &lt;fctr&gt;        &lt;POSc&gt;
   1:  January 2012  January 2012    2012-01-15
   2:  January 2012  January 2012    2012-01-15
   3:  January 2012  January 2012    2012-01-15
   4:  January 2012  January 2012    2012-01-15
   5:  January 2012  January 2012    2012-01-15
  ---                                          
5591: December 2014 December 2014    2014-12-15
5592: December 2014 December 2014    2014-12-15
5593: December 2014 December 2014    2014-12-15
5594: December 2014 December 2014    2014-12-15
5595: December 2014 December 2014    2014-12-15</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="sc">!</span><span class="fu">is.na</span>(accidents.dt<span class="sc">$</span>month.POSIXct))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>(accidents.per.month <span class="ot">&lt;-</span> accidents.dt[, <span class="fu">list</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">total.accidents=</span>.N,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">total.people=</span><span class="fu">sum</span>(deaths<span class="sc">+</span>people.severely.injured<span class="sc">+</span>people.slightly.injured),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">deaths=</span><span class="fu">sum</span>(deaths),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">people.severely.injured=</span><span class="fu">sum</span>(people.severely.injured),</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">people.slightly.injured=</span><span class="fu">sum</span>(people.slightly.injured),</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">next.POSIXct =</span> month.POSIXct <span class="sc">+</span> one.day <span class="sc">*</span> <span class="dv">30</span>,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">month01.str =</span> <span class="fu">paste0</span>(<span class="fu">strftime</span>(month.POSIXct, <span class="st">"%Y-%m"</span>), <span class="st">"-01"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>), <span class="at">by=</span>.(month, month.str, month.text, month.POSIXct)][, <span class="fu">let</span>(</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">month01.POSIXct =</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(month01.str, <span class="st">"%Y-%m-%d"</span>)),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">next01.str =</span> <span class="fu">paste0</span>(<span class="fu">strftime</span>(next.POSIXct, <span class="st">"%Y-%m"</span>), <span class="st">"-01"</span>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>)][</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>, <span class="at">next01.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(next01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             month month.str     month.text month.POSIXct total.accidents
            &lt;fctr&gt;    &lt;char&gt;         &lt;char&gt;        &lt;POSc&gt;           &lt;int&gt;
 1:   January 2012   2012-01   January 2012    2012-01-15              11
 2:  February 2012   2012-02  February 2012    2012-02-15              19
 3:     March 2012   2012-03     March 2012    2012-03-15              76
 4:     April 2012   2012-04     April 2012    2012-04-15             113
 5:       May 2012   2012-05       May 2012    2012-05-15             224
 6:      June 2012   2012-06      June 2012    2012-06-15             276
 7:      July 2012   2012-07      July 2012    2012-07-15             382
 8:    August 2012   2012-08    August 2012    2012-08-15             328
 9: September 2012   2012-09 September 2012    2012-09-15             280
10:   October 2012   2012-10   October 2012    2012-10-15             171
11:  November 2012   2012-11  November 2012    2012-11-15             105
12:  December 2012   2012-12  December 2012    2012-12-15              17
13:   January 2013   2013-01   January 2013    2013-01-15               6
14:  February 2013   2013-02  February 2013    2013-02-15              13
15:     March 2013   2013-03     March 2013    2013-03-15              28
16:     April 2013   2013-04     April 2013    2013-04-15              91
17:       May 2013   2013-05       May 2013    2013-05-15             258
18:      June 2013   2013-06      June 2013    2013-06-15             286
19:      July 2013   2013-07      July 2013    2013-07-15             315
20:    August 2013   2013-08    August 2013    2013-08-15             326
21: September 2013   2013-09 September 2013    2013-09-15             268
22:   October 2013   2013-10   October 2013    2013-10-15             204
23:  November 2013   2013-11  November 2013    2013-11-15              75
24:  December 2013   2013-12  December 2013    2013-12-15              15
25:   January 2014   2014-01   January 2014    2014-01-15              10
26:  February 2014   2014-02  February 2014    2014-02-15               6
27:     March 2014   2014-03     March 2014    2014-03-15              12
28:     April 2014   2014-04     April 2014    2014-04-15              90
29:       May 2014   2014-05       May 2014    2014-05-15             202
30:      June 2014   2014-06      June 2014    2014-06-15             269
31:      July 2014   2014-07      July 2014    2014-07-15             285
32:    August 2014   2014-08    August 2014    2014-08-15             308
33: September 2014   2014-09 September 2014    2014-09-15             279
34:   October 2014   2014-10   October 2014    2014-10-15             166
35:  November 2014   2014-11  November 2014    2014-11-15              71
36:  December 2014   2014-12  December 2014    2014-12-15              10
             month month.str     month.text month.POSIXct total.accidents
    total.people deaths people.severely.injured people.slightly.injured
           &lt;int&gt;  &lt;int&gt;                   &lt;int&gt;                   &lt;int&gt;
 1:           11      1                       0                      10
 2:           20      0                       0                      20
 3:           76      0                       3                      73
 4:          114      0                       5                     109
 5:          228      1                       9                     218
 6:          282      3                      11                     268
 7:          388      2                      15                     371
 8:          338      1                      21                     316
 9:          284      2                      12                     270
10:          172      3                       7                     162
11:          105      1                       3                     101
12:           17      0                       2                      15
13:            6      0                       0                       6
14:           14      1                       1                      12
15:           28      1                       1                      26
16:           93      2                       6                      85
17:          268      5                      19                     244
18:          295      0                      16                     279
19:          325      2                      21                     302
20:          333      2                      17                     314
21:          280      4                      21                     255
22:          204      1                      13                     190
23:           76      2                       3                      71
24:           15      0                       1                      14
25:           10      0                       0                      10
26:            6      0                       0                       6
27:           12      0                       2                      10
28:           91      2                       6                      83
29:          211      2                       7                     202
30:          288      0                      15                     273
31:          291      2                      20                     269
32:          315      1                      12                     302
33:          281      3                      16                     262
34:          170      0                       8                     162
35:           72      1                       2                      69
36:           10      0                       0                      10
    total.people deaths people.severely.injured people.slightly.injured
           next.POSIXct month01.str month01.POSIXct next01.str next01.POSIXct
                 &lt;POSc&gt;      &lt;char&gt;          &lt;POSc&gt;     &lt;char&gt;         &lt;POSc&gt;
 1: 2012-02-14 00:00:00  2012-01-01      2012-01-01 2012-02-01     2012-02-01
 2: 2012-03-16 01:00:00  2012-02-01      2012-02-01 2012-03-01     2012-03-01
 3: 2012-04-14 00:00:00  2012-03-01      2012-03-01 2012-04-01     2012-04-01
 4: 2012-05-15 00:00:00  2012-04-01      2012-04-01 2012-05-01     2012-05-01
 5: 2012-06-14 00:00:00  2012-05-01      2012-05-01 2012-06-01     2012-06-01
 6: 2012-07-15 00:00:00  2012-06-01      2012-06-01 2012-07-01     2012-07-01
 7: 2012-08-14 00:00:00  2012-07-01      2012-07-01 2012-08-01     2012-08-01
 8: 2012-09-14 00:00:00  2012-08-01      2012-08-01 2012-09-01     2012-09-01
 9: 2012-10-15 00:00:00  2012-09-01      2012-09-01 2012-10-01     2012-10-01
10: 2012-11-13 23:00:00  2012-10-01      2012-10-01 2012-11-01     2012-11-01
11: 2012-12-15 00:00:00  2012-11-01      2012-11-01 2012-12-01     2012-12-01
12: 2013-01-14 00:00:00  2012-12-01      2012-12-01 2013-01-01     2013-01-01
13: 2013-02-14 00:00:00  2013-01-01      2013-01-01 2013-02-01     2013-02-01
14: 2013-03-17 01:00:00  2013-02-01      2013-02-01 2013-03-01     2013-03-01
15: 2013-04-14 00:00:00  2013-03-01      2013-03-01 2013-04-01     2013-04-01
16: 2013-05-15 00:00:00  2013-04-01      2013-04-01 2013-05-01     2013-05-01
17: 2013-06-14 00:00:00  2013-05-01      2013-05-01 2013-06-01     2013-06-01
18: 2013-07-15 00:00:00  2013-06-01      2013-06-01 2013-07-01     2013-07-01
19: 2013-08-14 00:00:00  2013-07-01      2013-07-01 2013-08-01     2013-08-01
20: 2013-09-14 00:00:00  2013-08-01      2013-08-01 2013-09-01     2013-09-01
21: 2013-10-15 00:00:00  2013-09-01      2013-09-01 2013-10-01     2013-10-01
22: 2013-11-13 23:00:00  2013-10-01      2013-10-01 2013-11-01     2013-11-01
23: 2013-12-15 00:00:00  2013-11-01      2013-11-01 2013-12-01     2013-12-01
24: 2014-01-14 00:00:00  2013-12-01      2013-12-01 2014-01-01     2014-01-01
25: 2014-02-14 00:00:00  2014-01-01      2014-01-01 2014-02-01     2014-02-01
26: 2014-03-17 01:00:00  2014-02-01      2014-02-01 2014-03-01     2014-03-01
27: 2014-04-14 00:00:00  2014-03-01      2014-03-01 2014-04-01     2014-04-01
28: 2014-05-15 00:00:00  2014-04-01      2014-04-01 2014-05-01     2014-05-01
29: 2014-06-14 00:00:00  2014-05-01      2014-05-01 2014-06-01     2014-06-01
30: 2014-07-15 00:00:00  2014-06-01      2014-06-01 2014-07-01     2014-07-01
31: 2014-08-14 00:00:00  2014-07-01      2014-07-01 2014-08-01     2014-08-01
32: 2014-09-14 00:00:00  2014-08-01      2014-08-01 2014-09-01     2014-09-01
33: 2014-10-15 00:00:00  2014-09-01      2014-09-01 2014-10-01     2014-10-01
34: 2014-11-13 23:00:00  2014-10-01      2014-10-01 2014-11-01     2014-11-01
35: 2014-12-15 00:00:00  2014-11-01      2014-11-01 2014-12-01     2014-12-01
36: 2015-01-14 00:00:00  2014-12-01      2014-12-01 2015-01-01     2015-01-01
           next.POSIXct month01.str month01.POSIXct next01.str next01.POSIXct</code></pre>
</div>
</div>
<!-- paragraph -->
<p>We plot the accidents per month below.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>accidents.tall <span class="ot">&lt;-</span> <span class="fu">melt</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  accidents.per.month,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure.vars=</span><span class="fu">c</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"deaths"</span>, <span class="st">"people.severely.injured"</span>, <span class="st">"people.slightly.injured"</span>),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">variable.name=</span><span class="st">"severity"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">value.name=</span><span class="st">"people"</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>severity.colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"people.slightly.injured"</span><span class="ot">=</span><span class="st">"#FEE0D2"</span>,<span class="co">#lite red</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"people.severely.injured"</span><span class="ot">=</span><span class="st">"#FB6A4A"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">deaths=</span><span class="st">"#A50F15"</span>)<span class="co">#dark red</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, people, <span class="at">fill=</span>severity),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>accidents.tall)<span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>severity.colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/accidentsPerMonth-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<p>In each accident, there are counts of people who died, along with people who suffered severe and slight injuries. <!-- comment --> Below we classify the severity of each accident according to the worst outcome among the people affected.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>accidents.dt[</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>, severity.str <span class="sc">:</span><span class="er">=</span> <span class="fu">fcase</span>(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="sc">&lt;</span> deaths, <span class="st">"deaths"</span>,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="sc">&lt;</span> people.severely.injured, <span class="st">"people.severely.injured"</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">default=</span><span class="st">"people.slightly.injured"</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>, severity <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(severity.str, <span class="fu">names</span>(severity.colors))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>, <span class="fu">table</span>(severity)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>severity
people.slightly.injured people.severely.injured                  deaths 
                   5262                     289                      44 </code></pre>
</div>
</div>
<!-- paragraph -->
<p>The output above shows that accidents with only slight injuries are most frequent, and accidents with at least one death are least frequent. <!-- comment --> Below we compute counts per month.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(counts.per.month <span class="ot">&lt;-</span> counts.dt[, <span class="fu">let</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">month.POSIXct =</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(<span class="fu">paste0</span>(month.str, <span class="st">"-15"</span>), <span class="st">"%Y-%m-%d"</span>)),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">month.text =</span> <span class="fu">strftime</span>(date, <span class="st">"%B %Y"</span>),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">day.of.the.month =</span> <span class="fu">as.integer</span>(<span class="fu">strftime</span>(date, <span class="st">"%d"</span>))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>)][</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>, <span class="at">month :=</span> <span class="fu">factor</span>(month.text, month.levs)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>][, <span class="fu">list</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">days=</span>.N,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean.per.day=</span><span class="fu">mean</span>(count),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">count=</span><span class="fu">sum</span>(count),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">month01.str =</span> <span class="fu">paste0</span>(month.str, <span class="st">"-01"</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>), <span class="at">by=</span>.(location, month, month.str, month.POSIXct)][</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span> <span class="sc">&lt;</span> count</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>, <span class="at">month01.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(month01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>, <span class="at">next.POSIXct :=</span> month01.POSIXct <span class="sc">+</span> one.day <span class="sc">*</span> <span class="dv">31</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>, <span class="at">next01.str :=</span> <span class="fu">paste0</span>(<span class="fu">strftime</span>(next.POSIXct, <span class="st">"%Y-%m"</span>), <span class="st">"-01"</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>, <span class="at">next01.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(next01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>, <span class="at">days.in.month :=</span> <span class="fu">as.integer</span>(<span class="fu">round</span>(<span class="fu">difftime</span>(next01.POSIXct,month01.POSIXct,<span class="at">units=</span><span class="st">"days"</span>)))</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          location          month month.str month.POSIXct  days mean.per.day
            &lt;fctr&gt;         &lt;fctr&gt;    &lt;char&gt;        &lt;POSc&gt; &lt;int&gt;        &lt;num&gt;
  1:         Berri   January 2009   2009-01    2009-01-15    31     100.3226
  2:         Berri  February 2009   2009-02    2009-02-15    28     159.6786
  3:         Berri     March 2009   2009-03    2009-03-15    31     271.3226
  4:         Berri       May 2009   2009-05    2009-05-15    31    2972.8710
  5:         Berri      June 2009   2009-06    2009-06-15    30    3909.9333
 ---                                                                        
321: Totem_Laurier       May 2013   2013-05    2013-05-15    31    2746.4194
322: Totem_Laurier      June 2013   2013-06    2013-06-15    30    2828.6000
323: Totem_Laurier      July 2013   2013-07    2013-07-15    31    3238.3871
324: Totem_Laurier    August 2013   2013-08    2013-08-15    31    3162.7097
325: Totem_Laurier September 2013   2013-09    2013-09-15    18    2888.7778
      count month01.str month01.POSIXct        next.POSIXct next01.str
      &lt;int&gt;      &lt;char&gt;          &lt;POSc&gt;              &lt;POSc&gt;     &lt;char&gt;
  1:   3110  2009-01-01      2009-01-01 2009-02-01 00:00:00 2009-02-01
  2:   4471  2009-02-01      2009-02-01 2009-03-04 00:00:00 2009-03-01
  3:   8411  2009-03-01      2009-03-01 2009-04-01 01:00:00 2009-04-01
  4:  92159  2009-05-01      2009-05-01 2009-06-01 00:00:00 2009-06-01
  5: 117298  2009-06-01      2009-06-01 2009-07-02 00:00:00 2009-07-01
 ---                                                                  
321:  85139  2013-05-01      2013-05-01 2013-06-01 00:00:00 2013-06-01
322:  84858  2013-06-01      2013-06-01 2013-07-02 00:00:00 2013-07-01
323: 100390  2013-07-01      2013-07-01 2013-08-01 00:00:00 2013-08-01
324:  98044  2013-08-01      2013-08-01 2013-09-01 00:00:00 2013-09-01
325:  51998  2013-09-01      2013-09-01 2013-10-02 00:00:00 2013-10-01
     next01.POSIXct days.in.month
             &lt;POSc&gt;         &lt;int&gt;
  1:     2009-02-01            31
  2:     2009-03-01            28
  3:     2009-04-01            31
  4:     2009-06-01            31
  5:     2009-07-01            30
 ---                             
321:     2013-06-01            31
322:     2013-07-01            30
323:     2013-08-01            31
324:     2013-09-01            31
325:     2013-10-01            30</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>counts.per.month[days <span class="sc">&lt;</span> days.in.month, {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(location, month, days, days.in.month)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>}]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 location          month  days days.in.month
                   &lt;fctr&gt;         &lt;fctr&gt; &lt;int&gt;         &lt;int&gt;
 1:                 Berri  November 2012     5            30
 2: Côte-Sainte-Catherine  November 2012     5            30
 3:         Maisonneuve 1  November 2012     5            30
 4:         Maisonneuve 2  November 2012     5            30
 5:               du Parc  November 2012     5            30
 6:          Pierre-Dupuy  November 2012     5            30
 7:                Rachel  November 2012     5            30
 8:                 Berri September 2013    18            30
 9: Côte-Sainte-Catherine September 2013    18            30
10:         Maisonneuve 1 September 2013    18            30
11:         Maisonneuve 2 September 2013    18            30
12:               du Parc September 2013    18            30
13:          Pierre-Dupuy September 2013    18            30
14:                Rachel September 2013    18            30
15:         Totem_Laurier September 2013    18            30</code></pre>
</div>
</div>
<!-- paragraph -->
<p>As shown above, some months do not have observations for all days.</p>
<!-- paragraph -->
</section>
<section id="regression" class="level2">
<h2 class="anchored" data-anchor-id="regression">Interactive viz of accident frequency</h2>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>complete.months <span class="ot">&lt;-</span> counts.per.month[days <span class="sc">==</span> days.in.month]</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>month.labels <span class="ot">&lt;-</span> counts.per.month[, {</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  .SD[<span class="fu">which.max</span>(count), ]</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>}, by<span class="ot">=</span>location]</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>day.labels <span class="ot">&lt;-</span> counts.dt[, {</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  .SD[<span class="fu">which.max</span>(count), ]</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>}, by<span class="ot">=</span>.(location, month)]</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>(city.wide.cyclists <span class="ot">&lt;-</span> counts.per.month[<span class="dv">0</span> <span class="sc">&lt;</span> count, <span class="fu">list</span>(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">locations=</span>.N,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">count=</span><span class="fu">sum</span>(count),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">month01.str =</span> <span class="fu">paste0</span>(month.str, <span class="st">"-01"</span>)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>), <span class="at">by=</span>.(month, month.str, month.POSIXct)][</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>, <span class="at">month01.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(month01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>, <span class="at">next.POSIXct :=</span> month01.POSIXct <span class="sc">+</span> one.day <span class="sc">*</span> <span class="dv">31</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>, <span class="at">next01.str :=</span> <span class="fu">paste0</span>(<span class="fu">strftime</span>(next.POSIXct, <span class="st">"%Y-%m"</span>), <span class="st">"-01"</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>, <span class="at">next01.POSIXct :=</span> <span class="fu">as.POSIXct</span>(<span class="fu">strptime</span>(next01.str, <span class="st">"%Y-%m-%d"</span>))</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             month month.str month.POSIXct locations  count month01.str
            &lt;fctr&gt;    &lt;char&gt;        &lt;POSc&gt;     &lt;int&gt;  &lt;int&gt;      &lt;char&gt;
 1:   January 2009   2009-01    2009-01-15         2  14245  2009-01-01
 2:  February 2009   2009-02    2009-02-15         2  24002  2009-02-01
 3:     March 2009   2009-03    2009-03-15         2  57980  2009-03-01
 4:       May 2009   2009-05    2009-05-15         2 149327  2009-05-01
 5:      June 2009   2009-06    2009-06-15         4 305555  2009-06-01
 6:      July 2009   2009-07    2009-07-15         5 466408  2009-07-01
 7:    August 2009   2009-08    2009-08-15         5 529256  2009-08-01
 8: September 2009   2009-09    2009-09-15         5 482695  2009-09-01
 9:   October 2009   2009-10    2009-10-15         5 252845  2009-10-01
10:  November 2009   2009-11    2009-11-15         5 196571  2009-11-01
11:  December 2009   2009-12    2009-12-15         4  51613  2009-12-01
12:     April 2009   2009-04    2009-04-15         1  50798  2009-04-01
13:   January 2010   2010-01    2010-01-15         4  33779  2010-01-01
14:  February 2010   2010-02    2010-02-15         4  31979  2010-02-01
15:     March 2010   2010-03    2010-03-15         4 110285  2010-03-01
16:     April 2010   2010-04    2010-04-15         5 269990  2010-04-01
17:       May 2010   2010-05    2010-05-15         4 431840  2010-05-01
18:      June 2010   2010-06    2010-06-15         5 576549  2010-06-01
19:      July 2010   2010-07    2010-07-15         5 624857  2010-07-01
20:    August 2010   2010-08    2010-08-15         5 542122  2010-08-01
21: September 2010   2010-09    2010-09-15         4 432133  2010-09-01
22:   October 2010   2010-10    2010-10-15         9 483345  2010-10-01
23:  November 2010   2010-11    2010-11-15         9 303612  2010-11-01
24:  December 2010   2010-12    2010-12-15         7  33511  2010-12-01
25:   January 2011   2011-01    2011-01-15         7  27488  2011-01-01
26:  February 2011   2011-02    2011-02-15         7  21101  2011-02-01
27:     March 2011   2011-03    2011-03-15         7  56810  2011-03-01
28:     April 2011   2011-04    2011-04-15         7 239323  2011-04-01
29:       May 2011   2011-05    2011-05-15         7 456569  2011-05-01
30:      June 2011   2011-06    2011-06-15         7 775132  2011-06-01
31:      July 2011   2011-07    2011-07-15         7 803831  2011-07-01
32:    August 2011   2011-08    2011-08-15         7 739778  2011-08-01
33: September 2011   2011-09    2011-09-15         7 714430  2011-09-01
34:   October 2011   2011-10    2011-10-15         7 272719  2011-10-01
35:   January 2012   2012-01    2012-01-15         7  20386  2012-01-01
36:  February 2012   2012-02    2012-02-15         7  26727  2012-02-01
37:     March 2012   2012-03    2012-03-15         7 146105  2012-03-01
38:     April 2012   2012-04    2012-04-15         7 365936  2012-04-01
39:       May 2012   2012-05    2012-05-15         7 694542  2012-05-01
40:      June 2012   2012-06    2012-06-15         7 753878  2012-06-01
41:      July 2012   2012-07    2012-07-15         7 825607  2012-07-01
42:    August 2012   2012-08    2012-08-15         7 753703  2012-08-01
43: September 2012   2012-09    2012-09-15         7 668560  2012-09-01
44:   October 2012   2012-10    2012-10-15         7 504382  2012-10-01
45:  November 2012   2012-11    2012-11-15         7  46030  2012-11-01
46:   January 2013   2013-01    2013-01-15         7  30313  2013-01-01
47:  February 2013   2013-02    2013-02-15         8  34702  2013-02-01
48:     March 2013   2013-03    2013-03-15         8  98303  2013-03-01
49:     April 2013   2013-04    2013-04-15         8 396326  2013-04-01
50:       May 2013   2013-05    2013-05-15         8 811126  2013-05-01
51:      June 2013   2013-06    2013-06-15         8 767951  2013-06-01
52:      July 2013   2013-07    2013-07-15         8 916662  2013-07-01
53:    August 2013   2013-08    2013-08-15         8 856066  2013-08-01
54: September 2013   2013-09    2013-09-15         8 450513  2013-09-01
             month month.str month.POSIXct locations  count month01.str
    month01.POSIXct        next.POSIXct next01.str next01.POSIXct
             &lt;POSc&gt;              &lt;POSc&gt;     &lt;char&gt;         &lt;POSc&gt;
 1:      2009-01-01 2009-02-01 00:00:00 2009-02-01     2009-02-01
 2:      2009-02-01 2009-03-04 00:00:00 2009-03-01     2009-03-01
 3:      2009-03-01 2009-04-01 01:00:00 2009-04-01     2009-04-01
 4:      2009-05-01 2009-06-01 00:00:00 2009-06-01     2009-06-01
 5:      2009-06-01 2009-07-02 00:00:00 2009-07-01     2009-07-01
 6:      2009-07-01 2009-08-01 00:00:00 2009-08-01     2009-08-01
 7:      2009-08-01 2009-09-01 00:00:00 2009-09-01     2009-09-01
 8:      2009-09-01 2009-10-02 00:00:00 2009-10-01     2009-10-01
 9:      2009-10-01 2009-11-01 00:00:00 2009-11-01     2009-11-01
10:      2009-11-01 2009-12-01 23:00:00 2009-12-01     2009-12-01
11:      2009-12-01 2010-01-01 00:00:00 2010-01-01     2010-01-01
12:      2009-04-01 2009-05-02 00:00:00 2009-05-01     2009-05-01
13:      2010-01-01 2010-02-01 00:00:00 2010-02-01     2010-02-01
14:      2010-02-01 2010-03-04 00:00:00 2010-03-01     2010-03-01
15:      2010-03-01 2010-04-01 01:00:00 2010-04-01     2010-04-01
16:      2010-04-01 2010-05-02 00:00:00 2010-05-01     2010-05-01
17:      2010-05-01 2010-06-01 00:00:00 2010-06-01     2010-06-01
18:      2010-06-01 2010-07-02 00:00:00 2010-07-01     2010-07-01
19:      2010-07-01 2010-08-01 00:00:00 2010-08-01     2010-08-01
20:      2010-08-01 2010-09-01 00:00:00 2010-09-01     2010-09-01
21:      2010-09-01 2010-10-02 00:00:00 2010-10-01     2010-10-01
22:      2010-10-01 2010-11-01 00:00:00 2010-11-01     2010-11-01
23:      2010-11-01 2010-12-01 23:00:00 2010-12-01     2010-12-01
24:      2010-12-01 2011-01-01 00:00:00 2011-01-01     2011-01-01
25:      2011-01-01 2011-02-01 00:00:00 2011-02-01     2011-02-01
26:      2011-02-01 2011-03-04 00:00:00 2011-03-01     2011-03-01
27:      2011-03-01 2011-04-01 01:00:00 2011-04-01     2011-04-01
28:      2011-04-01 2011-05-02 00:00:00 2011-05-01     2011-05-01
29:      2011-05-01 2011-06-01 00:00:00 2011-06-01     2011-06-01
30:      2011-06-01 2011-07-02 00:00:00 2011-07-01     2011-07-01
31:      2011-07-01 2011-08-01 00:00:00 2011-08-01     2011-08-01
32:      2011-08-01 2011-09-01 00:00:00 2011-09-01     2011-09-01
33:      2011-09-01 2011-10-02 00:00:00 2011-10-01     2011-10-01
34:      2011-10-01 2011-11-01 00:00:00 2011-11-01     2011-11-01
35:      2012-01-01 2012-02-01 00:00:00 2012-02-01     2012-02-01
36:      2012-02-01 2012-03-03 00:00:00 2012-03-01     2012-03-01
37:      2012-03-01 2012-04-01 01:00:00 2012-04-01     2012-04-01
38:      2012-04-01 2012-05-02 00:00:00 2012-05-01     2012-05-01
39:      2012-05-01 2012-06-01 00:00:00 2012-06-01     2012-06-01
40:      2012-06-01 2012-07-02 00:00:00 2012-07-01     2012-07-01
41:      2012-07-01 2012-08-01 00:00:00 2012-08-01     2012-08-01
42:      2012-08-01 2012-09-01 00:00:00 2012-09-01     2012-09-01
43:      2012-09-01 2012-10-02 00:00:00 2012-10-01     2012-10-01
44:      2012-10-01 2012-11-01 00:00:00 2012-11-01     2012-11-01
45:      2012-11-01 2012-12-01 23:00:00 2012-12-01     2012-12-01
46:      2013-01-01 2013-02-01 00:00:00 2013-02-01     2013-02-01
47:      2013-02-01 2013-03-04 00:00:00 2013-03-01     2013-03-01
48:      2013-03-01 2013-04-01 01:00:00 2013-04-01     2013-04-01
49:      2013-04-01 2013-05-02 00:00:00 2013-05-01     2013-05-01
50:      2013-05-01 2013-06-01 00:00:00 2013-06-01     2013-06-01
51:      2013-06-01 2013-07-02 00:00:00 2013-07-01     2013-07-01
52:      2013-07-01 2013-08-01 00:00:00 2013-08-01     2013-08-01
53:      2013-08-01 2013-09-01 00:00:00 2013-09-01     2013-09-01
54:      2013-09-01 2013-10-02 00:00:00 2013-10-01     2013-10-01
    month01.POSIXct        next.POSIXct next01.str next01.POSIXct</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>month.str.vec <span class="ot">&lt;-</span> <span class="fu">strftime</span>(<span class="fu">seq</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">strptime</span>(<span class="st">"2012-01-15"</span>, <span class="st">"%Y-%m-%d"</span>),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">strptime</span>(<span class="st">"2013-01-15"</span>, <span class="st">"%Y-%m-%d"</span>),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">by=</span><span class="st">"month"</span>), <span class="st">"%Y-%m"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>city.wide.complete <span class="ot">&lt;-</span> complete.months[<span class="dv">0</span> <span class="sc">&lt;</span> count, <span class="fu">list</span>(</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">locations=</span>.N,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">count=</span><span class="fu">sum</span>(count),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">month01.str =</span> <span class="fu">paste0</span>(month.str, <span class="st">"-01"</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>.(month, month.str, month.POSIXct)]</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(city.wide.complete, month.str)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>scatter.cyclists <span class="ot">&lt;-</span> city.wide.complete[month.str.vec]</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>scatter.accidents <span class="ot">&lt;-</span> accidents.per.month[scatter.cyclists, on<span class="ot">=</span><span class="fu">list</span>(month.str)]</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>scatter.not.na <span class="ot">&lt;-</span> scatter.accidents[<span class="sc">!</span><span class="fu">is.na</span>(locations),]</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>scatter.max <span class="ot">&lt;-</span> scatter.not.na[locations<span class="sc">==</span><span class="fu">max</span>(locations)]</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(total.accidents <span class="sc">~</span> count <span class="sc">-</span> <span class="dv">1</span>, scatter.max)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>scatter.max[</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>, pred.accidents <span class="sc">:</span><span class="er">=</span> <span class="fu">predict</span>(fit)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>, <span class="fu">mean</span>(total.accidents<span class="sc">/</span>count)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.0004201563</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">regression=</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Numbers of accidents and cyclists"</span>)<span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>      count, pred.accidents),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">color=</span><span class="st">"grey"</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">data=</span>scatter.max)<span class="sc">+</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>      count, total.accidents),</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">shape=</span><span class="dv">1</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">clickSelects=</span><span class="st">"month"</span>,</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">size=</span><span class="dv">5</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha=</span><span class="fl">0.75</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">data=</span>scatter.max)<span class="sc">+</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">"Total bike accidents (all Montreal locations)"</span>)<span class="sc">+</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Total cyclists (all Montreal locations)"</span>),</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">timeSeries=</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="st">"Time series of accident frequency"</span>)<span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Month"</span>)<span class="sc">+</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>      month.POSIXct, total.accidents<span class="sc">/</span>count),</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">clickSelects=</span><span class="st">"month"</span>,             </span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">size=</span><span class="dv">5</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha=</span><span class="fl">0.75</span>,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">data=</span>scatter.max))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<script type="text/javascript" src="Ch09vizregression/vendor/d3.v3.js"></script>
<script type="text/javascript" src="Ch09vizregression/animint.js"></script>
<script type="text/javascript" src="Ch09vizregression/vendor/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="Ch09vizregression/vendor/selectize.min.js"></script>
<link rel="stylesheet" type="text/css" href="Ch09vizregression/vendor/selectize.css">
<script type="text/javascript" src="Ch09vizregression/vendor/driver.js.iife.js"></script>
<link rel="stylesheet" href="Ch09vizregression/vendor/driver.css">
<p>
</p>
<div id="Ch09vizregression">

</div>
<script>var Ch09vizregression = new animint("#Ch09vizregression", "Ch09vizregression/plot.json");</script>
</div>
</div>
<!-- paragraph -->
<p>The data viz above shows two data visualizations of city-wide accident frequency over time. <!-- comment --> The plot on the left shows that the number of accidents grows with the number of cyclists. <!-- comment --> The plot on the right shows the frequency of accidents over time.</p>
<!-- paragraph -->
</section>
<section id="details" class="level2">
<h2 class="anchored" data-anchor-id="details">Interactive viz with map and details</h2>
<!-- paragraph -->
<p>The plot below is a dotplot of accidents for each month. <!-- comment --> Each dot represents one person who got in an accident.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(accidents.cumsum <span class="ot">&lt;-</span> accidents.dt[</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order</span>(date.POSIXct, month, severity)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>, <span class="at">accident.i :=</span> <span class="fu">seq_along</span>(severity)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>, <span class="at">by=</span>.(date.POSIXct, month)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>, <span class="at">day.of.the.month :=</span> <span class="fu">as.integer</span>(<span class="fu">strftime</span>(date.POSIXct, <span class="st">"%d"</span>))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date.str time.str deaths people.severely.injured
          &lt;char&gt;   &lt;char&gt;  &lt;int&gt;                   &lt;int&gt;
   1: 2012-01-02    18:35      0                       0
   2: 2012-01-05    21:50      0                       0
   3: 2012-01-09    21:15      0                       0
   4: 2012-01-10    15:40      0                       0
   5: 2012-01-10     0:15      0                       0
  ---                                                   
5591: 2014-12-19    12:22      0                       0
5592: 2014-12-19    19:50      0                       0
5593: 2014-12-26    19:56      0                       0
5594: 2014-12-27    12:35      0                       0
5595: 2014-12-30    11:55      0                       0
      people.slightly.injured street.number             street   cross.street
                        &lt;int&gt;         &lt;int&gt;             &lt;char&gt;         &lt;char&gt;
   1:                       1            NA ST JEAN BAPTISTE O     AV ROULEAU
   2:                       1            NA             FOSTER        JANELLE
   3:                       1            NA           ROSEMONT    DES ERABLES
   4:                       1            NA         ST ANTOINE      MANSFIELD
   5:                       1            NA         TASCHEREAU         ANGELE
  ---                                                                        
5591:                       1            NA    COTE DES NEIGES       DES PINS
5592:                       1            NA      BOUTHILLIER N      FRONTENAC
5593:                       1            NA  BD DU SEMINAIRE N     ST GEORGES
5594:                       1            NA   CH DES PATRIOTES        1RE RUE
5595:                       1         14965     PIERREFONDS BD JACQUES BIZARD
      location.int position.int                          position
             &lt;int&gt;        &lt;int&gt;                            &lt;char&gt;
   1:           32            6               Voie de circulation
   2:           34            6               Voie de circulation
   3:           NA            6               Voie de circulation
   4:           32            6               Voie de circulation
   5:           32            6               Voie de circulation
  ---                                                            
5591:           32            6               Voie de circulation
5592:           32           NA                              &lt;NA&gt;
5593:           32            8       Terre-plein central ou îlot
5594:           33            6               Voie de circulation
5595:           33            5 Voie cyclable / chaussée désignée
                                         location date.POSIXct month.str
                                           &lt;char&gt;       &lt;POSc&gt;    &lt;char&gt;
   1:         En intersection (moins de 5 mètres)   2012-01-02   2012-01
   2:       Entre intersections (100 mètres et +)   2012-01-05   2012-01
   3:                                        &lt;NA&gt;   2012-01-09   2012-01
   4:         En intersection (moins de 5 mètres)   2012-01-10   2012-01
   5:         En intersection (moins de 5 mètres)   2012-01-10   2012-01
  ---                                                                   
5591:         En intersection (moins de 5 mètres)   2014-12-19   2014-12
5592:         En intersection (moins de 5 mètres)   2014-12-19   2014-12
5593:         En intersection (moins de 5 mètres)   2014-12-26   2014-12
5594: Près d'une intersection/carrefour giratoire   2014-12-27   2014-12
5595: Près d'une intersection/carrefour giratoire   2014-12-30   2014-12
         month.text         month month.POSIXct            severity.str
             &lt;char&gt;        &lt;fctr&gt;        &lt;POSc&gt;                  &lt;char&gt;
   1:  January 2012  January 2012    2012-01-15 people.slightly.injured
   2:  January 2012  January 2012    2012-01-15 people.slightly.injured
   3:  January 2012  January 2012    2012-01-15 people.slightly.injured
   4:  January 2012  January 2012    2012-01-15 people.slightly.injured
   5:  January 2012  January 2012    2012-01-15 people.slightly.injured
  ---                                                                  
5591: December 2014 December 2014    2014-12-15 people.slightly.injured
5592: December 2014 December 2014    2014-12-15 people.slightly.injured
5593: December 2014 December 2014    2014-12-15 people.slightly.injured
5594: December 2014 December 2014    2014-12-15 people.slightly.injured
5595: December 2014 December 2014    2014-12-15 people.slightly.injured
                     severity accident.i day.of.the.month
                       &lt;fctr&gt;      &lt;int&gt;            &lt;int&gt;
   1: people.slightly.injured          1                2
   2: people.slightly.injured          1                5
   3: people.slightly.injured          1                9
   4: people.slightly.injured          1               10
   5: people.slightly.injured          2               10
  ---                                                    
5591: people.slightly.injured          1               19
5592: people.slightly.injured          2               19
5593: people.slightly.injured          1               26
5594: people.slightly.injured          1               27
5595: people.slightly.injured          1               30</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.margin=</span>grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>))<span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="st">"month"</span>)<span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="dv">15</span>, <span class="dv">25</span>, <span class="at">label=</span>month), <span class="at">data=</span>accidents.per.month)<span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>severity.colors)<span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"day of the month"</span>, <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>))<span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    day.of.the.month, accident.i, <span class="at">fill=</span>severity),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape=</span><span class="dv">21</span>,</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>accidents.cumsum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(counter.locations <span class="ot">&lt;-</span> <span class="fu">data.table</span>(montreal.bikes<span class="sc">$</span>counter.locations)[, <span class="fu">let</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> coord_X,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> coord_Y</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>)][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id                      nom              nom_comptage
    &lt;char&gt;                   &lt;char&gt;                    &lt;char&gt;
 1:      1              St-Urbain_1              Saint-Urbain
 2:      2                Brebeuf_1                   Brebeuf
 3:      4            Maisonneuve_1             Maisonneuve_1
 4:      5            Maisonneuve_2             Maisonneuve_2
 5:      6          Rachel/Papineau           Rachel/Papineau
 6:      7             University_1                University
 7:      8     Cote-Ste-Catherine_1                       CSC
 8:     10        Jacques-Cartier_1      Pont_Jacques-Cartier
 9:     12           Pierre-Dupuy_1                   PierDup
10:     14             St-Antoine_1             Saint-Antoine
11:     15                  Viger_1                     Viger
12:     17            Maisonneuve_3             Maisonneuve_3
13:     19         Piste_Notre-Dame                Notre-Dame
14:     22                   Parc_1                      Parc
15:     23 Rachel/H\xf4tel-de-Ville  Rachel/H\xf4tel de Ville
16:     29                  Boyer_1                     Boyer
17:     36    Ren\xe9-L\xe9vesque_2       Ren\xe9-L\xe9vesque
18:     37            Totem_Laurier             Totem_Laurier
19:      3                  Berri_1                    Berri1
20:     38                   Parc_2          Parc U-Zelt Test
21:     39               St-Laurent Saint-Laurent U-Zelt Test
        id                      nom              nom_comptage
                   Etat         Type Annee_implante   coord_X  coord_Y
                 &lt;char&gt;       &lt;char&gt;         &lt;char&gt;     &lt;num&gt;    &lt;num&gt;
 1:            Existant     compteur           2014 -73.58888 45.51955
 2:            Existant     compteur           2009 -73.57398 45.52741
 3: \xc0 r\xe9installer     compteur           2008 -73.56159 45.51479
 4:            Existant     compteur           2008 -73.57508 45.50054
 5:            Existant     compteur           2007 -73.56965 45.53036
 6:            Existant     compteur           2013 -73.57512 45.50574
 7:            Existant     compteur           2010 -73.60783 45.51496
 8:            Existant     compteur           2011 -73.55458 45.52560
 9:            Existant     compteur           2010 -73.54455 45.49966
10:            Existant     compteur           2013 -73.55779 45.50625
11:            Existant     compteur           2013 -73.55909 45.50714
12:            Existant     compteur           2013 -73.58523 45.49056
13:            Existant     compteur           2013 -73.54404 45.53140
14:            Existant     compteur           2010 -73.58171 45.51346
15:            Existant     compteur           2013 -73.58025 45.51958
16:            Existant     compteur           2013 -73.60523 45.53840
17:            Existant     compteur           2013 -73.55404 45.51697
18:            Existant        totem           2013 -73.58883 45.52777
19:            Existant     compteur           2008 -73.56284 45.51613
20:            Existant Projet-pilot           2015 -73.58221 45.51370
21:            Existant Projet-pilot           2015 -73.60311 45.52782
                   Etat         Type Annee_implante   coord_X  coord_Y
          lon      lat
        &lt;num&gt;    &lt;num&gt;
 1: -73.58888 45.51955
 2: -73.57398 45.52741
 3: -73.56159 45.51479
 4: -73.57508 45.50054
 5: -73.56965 45.53036
 6: -73.57512 45.50574
 7: -73.60783 45.51496
 8: -73.55458 45.52560
 9: -73.54455 45.49966
10: -73.55779 45.50625
11: -73.55909 45.50714
12: -73.58523 45.49056
13: -73.54404 45.53140
14: -73.58171 45.51346
15: -73.58025 45.51958
16: -73.60523 45.53840
17: -73.55404 45.51697
18: -73.58883 45.52777
19: -73.56284 45.51613
20: -73.58221 45.51370
21: -73.60311 45.52782
          lon      lat</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>loc.name.code <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Berri1"</span><span class="ot">=</span><span class="st">"Berri"</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Brebeuf"</span><span class="ot">=</span><span class="st">"Brébeuf"</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CSC"</span><span class="ot">=</span><span class="st">"Côte-Sainte-Catherine"</span>,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Maisonneuve_1"</span><span class="ot">=</span><span class="st">"Maisonneuve 1"</span>,</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Maisonneuve_2"</span><span class="ot">=</span><span class="st">"Maisonneuve 2"</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Parc"</span><span class="ot">=</span><span class="st">"du Parc"</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PierDup"</span><span class="ot">=</span><span class="st">"Pierre-Dupuy"</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Rachel/Papineau"</span><span class="ot">=</span><span class="st">"Rachel"</span>,</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Saint-Urbain"</span><span class="ot">=</span><span class="st">"Saint-Urbain"</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Totem_Laurier"</span><span class="ot">=</span><span class="st">"Totem_Laurier"</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>counter.locations[, location <span class="sc">:</span><span class="er">=</span> loc.name.code[nom_comptage] ]</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>velo.counts <span class="ot">&lt;-</span> <span class="fu">table</span>(counts.dt<span class="sc">$</span>location)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>(show.locations <span class="ot">&lt;-</span> counter.locations[<span class="fu">names</span>(velo.counts), <span class="at">on=</span><span class="fu">list</span>(location)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id                  nom    nom_comptage                Etat     Type
    &lt;char&gt;               &lt;char&gt;          &lt;char&gt;              &lt;char&gt;   &lt;char&gt;
 1:      3              Berri_1          Berri1            Existant compteur
 2:      2            Brebeuf_1         Brebeuf            Existant compteur
 3:      8 Cote-Ste-Catherine_1             CSC            Existant compteur
 4:      4        Maisonneuve_1   Maisonneuve_1 \xc0 r\xe9installer compteur
 5:      5        Maisonneuve_2   Maisonneuve_2            Existant compteur
 6:     22               Parc_1            Parc            Existant compteur
 7:     12       Pierre-Dupuy_1         PierDup            Existant compteur
 8:      6      Rachel/Papineau Rachel/Papineau            Existant compteur
 9:      1          St-Urbain_1    Saint-Urbain            Existant compteur
10:     37        Totem_Laurier   Totem_Laurier            Existant    totem
    Annee_implante   coord_X  coord_Y       lon      lat              location
            &lt;char&gt;     &lt;num&gt;    &lt;num&gt;     &lt;num&gt;    &lt;num&gt;                &lt;char&gt;
 1:           2008 -73.56284 45.51613 -73.56284 45.51613                 Berri
 2:           2009 -73.57398 45.52741 -73.57398 45.52741               Brébeuf
 3:           2010 -73.60783 45.51496 -73.60783 45.51496 Côte-Sainte-Catherine
 4:           2008 -73.56159 45.51479 -73.56159 45.51479         Maisonneuve 1
 5:           2008 -73.57508 45.50054 -73.57508 45.50054         Maisonneuve 2
 6:           2010 -73.58171 45.51346 -73.58171 45.51346               du Parc
 7:           2010 -73.54455 45.49966 -73.54455 45.49966          Pierre-Dupuy
 8:           2007 -73.56965 45.53036 -73.56965 45.53036                Rachel
 9:           2014 -73.58888 45.51955 -73.58888 45.51955          Saint-Urbain
10:           2013 -73.58883 45.52777 -73.58883 45.52777         Totem_Laurier</code></pre>
</div>
</div>
<!-- paragraph -->
<p>The counter locations above will be plotted below. <!-- comment --> Note that we use <code>showSelected=month</code> and <code>clickSelects=location</code>.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>map.lim <span class="ot">&lt;-</span> show.locations[, <span class="fu">list</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">range.lat=</span><span class="fu">range</span>(lat),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">range.lon=</span><span class="fu">range</span>(lon)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>diff.vec <span class="ot">&lt;-</span> <span class="fu">sapply</span>(map.lim, diff)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>diff.mat <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">matrix</span>(diff.vec, <span class="dv">2</span>, <span class="dv">2</span>, <span class="at">byrow=</span><span class="cn">TRUE</span>)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>scale.mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(map.lim) <span class="sc">+</span> diff.mat</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>location.colors <span class="ot">&lt;-</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"#8DD3C7"</span>, <span class="st">"#FFFFB3"</span>, <span class="st">"#BEBADA"</span>, <span class="st">"#FB8072"</span>, <span class="st">"#80B1D3"</span>, <span class="st">"#FDB462"</span>, </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#B3DE69"</span>, <span class="st">"#FCCDE5"</span>, <span class="st">"#D9D9D9"</span>, <span class="st">"#BC80BD"</span>, <span class="st">"#CCEBC5"</span>, <span class="st">"#FFED6F"</span>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(location.colors) <span class="ot">&lt;-</span> show.locations<span class="sc">$</span>location</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>counts.per.month.loc <span class="ot">&lt;-</span> counts.per.month[show.locations, on<span class="ot">=</span><span class="fu">list</span>(location)]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>bike.paths <span class="ot">&lt;-</span> <span class="fu">data.table</span>(montreal.bikes<span class="sc">$</span>path.locations)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>some.paths <span class="ot">&lt;-</span> bike.paths[</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  scale.mat[<span class="dv">1</span>, <span class="st">"range.lat"</span>] <span class="sc">&lt;</span> lat <span class="sc">&amp;</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    scale.mat[<span class="dv">1</span>, <span class="st">"range.lon"</span>] <span class="sc">&lt;</span> lon <span class="sc">&amp;</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    lat <span class="sc">&lt;</span> scale.mat[<span class="dv">2</span>, <span class="st">"range.lat"</span>] <span class="sc">&amp;</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    lon <span class="sc">&lt;</span> scale.mat[<span class="dv">2</span>, <span class="st">"range.lon"</span>]]</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>mtl.map <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.margin=</span>grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>),</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line=</span><span class="fu">element_blank</span>(), <span class="at">axis.text=</span><span class="fu">element_blank</span>(), </span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks=</span><span class="fu">element_blank</span>(), <span class="at">axis.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.border =</span> <span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>(<span class="at">xlim=</span>map.lim<span class="sc">$</span>range.lon, <span class="at">ylim=</span>map.lim<span class="sc">$</span>range.lat)<span class="sc">+</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits=</span>scale.mat[, <span class="st">"range.lon"</span>])<span class="sc">+</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits=</span>scale.mat[, <span class="st">"range.lat"</span>])<span class="sc">+</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    lon, lat,</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip=</span>TYPE_VOIE,</span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">group=</span><span class="fu">paste</span>(feature.i, path.i)),</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"grey"</span>,</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>some.paths)<span class="sc">+</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    lon, lat,</span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">label=</span>location),</span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>show.locations)</span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>mtl.map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<p>The plot below shows the time period that each counter was in operation. <!-- comment --> Note that we use <code>geom_tallrect</code> with <code>clickSelects</code> to select the month.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>location.ranges <span class="ot">&lt;-</span> counts.per.month[<span class="dv">0</span> <span class="sc">&lt;</span> count, <span class="fu">list</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">min=</span><span class="fu">min</span>(month.POSIXct),</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max=</span><span class="fu">max</span>(month.POSIXct)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>), by<span class="ot">=</span>location]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>accidents.range <span class="ot">&lt;-</span> accidents.dt[, <span class="fu">data.table</span>(</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">location=</span><span class="st">"accidents"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">min=</span><span class="fu">min</span>(date.POSIXct),</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">max=</span><span class="fu">max</span>(date.POSIXct))]</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>MonthSummary <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_animint</span>(<span class="at">width=</span><span class="dv">450</span>, <span class="at">height=</span><span class="dv">250</span>)<span class="sc">+</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"range of dates in data"</span>)<span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"data type"</span>)<span class="sc">+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    min, location,</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">xend=</span>max, <span class="at">yend=</span>location,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span>location),</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>location.ranges, <span class="at">alpha=</span><span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>, <span class="at">size=</span><span class="dv">10</span>)<span class="sc">+</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>    min, location,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">xend=</span>max, <span class="at">yend=</span>location),</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span>severity.colors[[<span class="st">"deaths"</span>]],</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>accidents.range,</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="dv">10</span>)</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(MonthSummary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<p>The plot below shows the bike counts at each location and day.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>(dates <span class="ot">&lt;-</span> counts.dt[, <span class="fu">list</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.date =</span> date<span class="sc">-</span>one.day<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max.date =</span> date<span class="sc">+</span>one.day<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">locations=</span><span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(count))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>), <span class="at">by=</span><span class="fu">list</span>(date)][<span class="dv">0</span> <span class="sc">&lt;</span> locations])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            date            min.date            max.date locations
          &lt;POSc&gt;              &lt;POSc&gt;              &lt;POSc&gt;     &lt;int&gt;
   1: 2009-01-01 2008-12-31 12:00:00 2009-01-01 12:00:00         9
   2: 2009-01-02 2009-01-01 12:00:00 2009-01-02 12:00:00         9
   3: 2009-01-03 2009-01-02 12:00:00 2009-01-03 12:00:00         9
   4: 2009-01-04 2009-01-03 12:00:00 2009-01-04 12:00:00         9
   5: 2009-01-05 2009-01-04 12:00:00 2009-01-05 12:00:00         9
  ---                                                             
1604: 2013-09-14 2013-09-13 12:00:00 2013-09-14 12:00:00         8
1605: 2013-09-15 2013-09-14 12:00:00 2013-09-15 12:00:00         8
1606: 2013-09-16 2013-09-15 12:00:00 2013-09-16 12:00:00         8
1607: 2013-09-17 2013-09-16 12:00:00 2013-09-17 12:00:00         8
1608: 2013-09-18 2013-09-17 12:00:00 2013-09-18 12:00:00         8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(location.labels <span class="ot">&lt;-</span> counts.dt[</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>, .SD[<span class="fu">which.max</span>(count)]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>, <span class="at">by=</span><span class="fu">list</span>(location)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 location       date count month.str               loc.lines
                   &lt;fctr&gt;     &lt;POSc&gt; &lt;int&gt;    &lt;char&gt;                  &lt;char&gt;
 1:                 Berri 2010-06-15  7495   2010-06                   Berri
 2:               Brébeuf 2010-06-04  9235   2010-06                 Brébeuf
 3: Côte-Sainte-Catherine 2013-09-18  3330   2013-09 Côte\nSainte\nCatherine
 4:         Maisonneuve 1 2011-06-17  5355   2011-06          Maisonneuve\n1
 5:         Maisonneuve 2 2011-06-07  8332   2011-06          Maisonneuve\n2
 6:               du Parc 2011-09-27  4577   2011-09                du\nParc
 7:          Pierre-Dupuy 2013-07-21  4841   2013-07           Pierre\nDupuy
 8:                Rachel 2013-05-31  8555   2013-05                  Rachel
 9:          Saint-Urbain 2010-04-27  3856   2010-04           Saint\nUrbain
10:         Totem_Laurier 2013-08-21  4293   2013-08          Totem\nLaurier
    month.POSIXct     month.text day.of.the.month          month
           &lt;POSc&gt;         &lt;char&gt;            &lt;int&gt;         &lt;fctr&gt;
 1:    2010-06-15      June 2010               15      June 2010
 2:    2010-06-15      June 2010                4      June 2010
 3:    2013-09-15 September 2013               18 September 2013
 4:    2011-06-15      June 2011               17      June 2011
 5:    2011-06-15      June 2011                7      June 2011
 6:    2011-09-15 September 2011               27 September 2011
 7:    2013-07-15      July 2013               21      July 2013
 8:    2013-05-15       May 2013               31       May 2013
 9:    2010-04-15     April 2010               27     April 2010
10:    2013-08-15    August 2013               21    August 2013</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>TimeSeries <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin=</span>date<span class="sc">-</span>one.day<span class="sc">/</span><span class="dv">2</span>, <span class="at">xmax=</span>date<span class="sc">+</span>one.day<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span>date),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>dates, <span class="at">alpha=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    date, count, <span class="at">group=</span>location,</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span>location,</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span>location),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>counts.dt)<span class="sc">+</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    date, count, <span class="at">color=</span>location,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span>location,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span>location),</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>counts.dt)<span class="sc">+</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    date, count<span class="sc">+</span><span class="dv">200</span>, <span class="at">color=</span>location, <span class="at">label=</span>location,</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span>location,</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span>location),</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>location.labels)</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(TimeSeries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 407 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<p>The plot below shows the same data but for each month.</p>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>MonthSeries <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>, <span class="at">fill=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin=</span>month01.POSIXct, <span class="at">xmax=</span>next01.POSIXct),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"month"</span>,    </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>months,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, count, <span class="at">group=</span>location,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span>location),</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"location"</span>,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>counts.per.month)<span class="sc">+</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"month"</span>)<span class="sc">+</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"bike counts per month"</span>)<span class="sc">+</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, count, <span class="at">fill=</span>location,</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip=</span><span class="fu">paste</span>(</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>      count, <span class="st">"bikers counted at"</span>,</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>      location, <span class="st">"in"</span>, month)),</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"location"</span>,</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="dv">5</span>,</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"black"</span>,</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>counts.per.month)<span class="sc">+</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, count<span class="sc">+</span><span class="dv">5000</span>, <span class="at">color=</span>location, <span class="at">label=</span>location),</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"location"</span>,</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>month.labels)</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(MonthSeries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>counter.title <span class="ot">&lt;-</span> <span class="st">"mean cyclists per day"</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>accidents.title <span class="ot">&lt;-</span> <span class="st">"city-wide accidents"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>MonthFacet <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"All data, select month"</span>)<span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>, <span class="at">fill=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(facet <span class="sc">~</span> ., <span class="at">scales=</span><span class="st">"free"</span>)<span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.margin=</span>grid<span class="sc">::</span><span class="fu">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>))<span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin=</span>month01.POSIXct, <span class="at">xmax=</span>next01.POSIXct),</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"month"</span>,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>      city.wide.cyclists,</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">facet=</span>counter.title),</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, mean.per.day, <span class="at">group=</span>location,</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span>location),</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"location"</span>,</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(counts.per.month, <span class="at">facet=</span>counter.title))<span class="sc">+</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"month"</span>)<span class="sc">+</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">""</span>)<span class="sc">+</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, mean.per.day, <span class="at">color=</span>location,</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip=</span><span class="fu">paste</span>(</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>      count, <span class="st">"cyclists counted at"</span>,</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>      location, <span class="st">"in"</span>,</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>      days, <span class="st">"days of"</span>, month,</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sprintf</span>(<span class="st">"(mean %d cyclists/day)"</span>, <span class="fu">as.integer</span>(mean.per.day)))),</span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"location"</span>,</span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="dv">5</span>,</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill=</span><span class="st">"grey"</span>,</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(counts.per.month, <span class="at">facet=</span>counter.title))<span class="sc">+</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, mean.per.day<span class="sc">+</span><span class="dv">300</span>, <span class="at">color=</span>location, <span class="at">label=</span>location),</span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"location"</span>,</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(month.labels, <span class="at">facet=</span>counter.title))<span class="sc">+</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>severity.colors, <span class="at">breaks=</span><span class="fu">names</span>(severity.colors))<span class="sc">+</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>    month.POSIXct, people,</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill=</span>severity),</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"severity"</span>,</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat=</span><span class="st">"identity"</span>,</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">position=</span><span class="st">"identity"</span>,</span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="cn">NA</span>,</span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(accidents.tall, <span class="at">facet=</span>accidents.title))<span class="sc">+</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(</span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin=</span>month01.POSIXct, <span class="at">xmax=</span>next01.POSIXct,</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip=</span><span class="fu">paste</span>(</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(deaths<span class="sc">==</span><span class="dv">0</span>, <span class="st">""</span>,</span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(deaths<span class="sc">==</span><span class="dv">1</span>,</span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a>             <span class="st">"1 death,"</span>,</span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a>             <span class="fu">paste</span>(deaths, <span class="st">"deaths,"</span>))),</span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(people.severely.injured<span class="sc">==</span><span class="dv">0</span>, <span class="st">""</span>,</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(people.severely.injured<span class="sc">==</span><span class="dv">1</span>,</span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a>             <span class="st">"1 person severely injured,"</span>,</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>             <span class="fu">paste</span>(people.severely.injured,</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"people severely injured,"</span>))),</span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>      people.slightly.injured,</span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">"people slightly injured in"</span>,</span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>      month)),</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"month"</span>,</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="fl">0.5</span>,</span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(accidents.per.month,</span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>                    <span class="at">facet=</span>accidents.title))</span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>MonthFacet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(days.dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">day.POSIXct=</span><span class="fu">with</span>(months, <span class="fu">seq</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">min</span>(month01.POSIXct),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">max</span>(next01.POSIXct),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by=</span><span class="st">"day"</span>))</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>)[</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>, <span class="at">day.of.the.week :=</span> <span class="fu">strftime</span>(day.POSIXct, <span class="st">"%a"</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      day.POSIXct day.of.the.week
           &lt;POSc&gt;          &lt;char&gt;
   1:  2009-01-01             Thu
   2:  2009-01-02             Fri
   3:  2009-01-03             Sat
   4:  2009-01-04             Sun
   5:  2009-01-05             Mon
  ---                            
2188:  2014-12-28             Sun
2189:  2014-12-29             Mon
2190:  2014-12-30             Tue
2191:  2014-12-31             Wed
2192:  2015-01-01             Thu</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">## The following only works in locales with English days of the week.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>(weekend.dt <span class="ot">&lt;-</span> days.dt[</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  day.of.the.week <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Sat"</span>, <span class="st">"Sun"</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>][, <span class="fu">let</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">month.text =</span> <span class="fu">strftime</span>(day.POSIXct, <span class="st">"%B %Y"</span>),</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">day.of.the.month =</span> <span class="fu">as.integer</span>(<span class="fu">strftime</span>(day.POSIXct, <span class="st">"%d"</span>))</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>)][</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>, <span class="at">month :=</span> <span class="fu">factor</span>(month.text, month.levs)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>][])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     day.POSIXct day.of.the.week    month.text day.of.the.month         month
          &lt;POSc&gt;          &lt;char&gt;        &lt;char&gt;            &lt;int&gt;        &lt;fctr&gt;
  1:  2009-01-03             Sat  January 2009                3  January 2009
  2:  2009-01-04             Sun  January 2009                4  January 2009
  3:  2009-01-10             Sat  January 2009               10  January 2009
  4:  2009-01-11             Sun  January 2009               11  January 2009
  5:  2009-01-17             Sat  January 2009               17  January 2009
 ---                                                                         
622:  2014-12-14             Sun December 2014               14 December 2014
623:  2014-12-20             Sat December 2014               20 December 2014
624:  2014-12-21             Sun December 2014               21 December 2014
625:  2014-12-27             Sat December 2014               27 December 2014
626:  2014-12-28             Sun December 2014               28 December 2014</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>counter.title <span class="ot">&lt;-</span> <span class="st">"cyclists per day"</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>DaysFacet <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Selected month (weekends in grey)"</span>)<span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tallrect</span>(<span class="fu">aes</span>(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin=</span>day.of.the.month<span class="fl">-0.5</span>, <span class="at">xmax=</span>day.of.the.month<span class="fl">+0.5</span>,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">key=</span><span class="fu">paste</span>(day.POSIXct)),</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"month"</span>,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill=</span><span class="st">"grey"</span>,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span><span class="st">"white"</span>,</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span>weekend.dt)<span class="sc">+</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="st">"none"</span>)<span class="sc">+</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(facet <span class="sc">~</span> ., <span class="at">scales=</span><span class="st">"free"</span>)<span class="sc">+</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    day.of.the.month, count, <span class="at">group=</span>location,</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">key=</span>location,</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color=</span>location),</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="fu">c</span>(<span class="st">"location"</span>, <span class="st">"month"</span>),</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">chunk_vars=</span><span class="fu">c</span>(<span class="st">"month"</span>),</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(counts.dt, <span class="at">facet=</span>counter.title))<span class="sc">+</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span>location.colors)<span class="sc">+</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">""</span>)<span class="sc">+</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    day.of.the.month, count, <span class="at">color=</span>location,</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">key=</span><span class="fu">paste</span>(day.of.the.month, location),</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip=</span><span class="fu">paste</span>(</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>      count, <span class="st">"cyclists counted at"</span>,</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>      location, <span class="st">"on"</span>,</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>      date)),</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="fu">c</span>(<span class="st">"location"</span>, <span class="st">"month"</span>),</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="dv">5</span>,</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">chunk_vars=</span><span class="fu">c</span>(<span class="st">"month"</span>),</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill=</span><span class="st">"white"</span>,</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(counts.dt, <span class="at">facet=</span>counter.title))<span class="sc">+</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span>severity.colors, <span class="at">breaks=</span><span class="fu">names</span>(severity.colors))<span class="sc">+</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    <span class="dv">15</span>, <span class="dv">23</span>, <span class="at">label=</span>month, <span class="at">key=</span><span class="dv">1</span>),</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"month"</span>,</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(months, <span class="at">facet=</span>accidents.title))<span class="sc">+</span></span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="st">"day of the month"</span>, <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>))<span class="sc">+</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    day.of.the.month, count<span class="sc">+</span><span class="dv">500</span>, <span class="at">color=</span>location, <span class="at">label=</span>location,</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">key=</span>location),</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="fu">c</span>(<span class="st">"location"</span>, <span class="st">"month"</span>),</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">clickSelects=</span><span class="st">"location"</span>,</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(day.labels, <span class="at">facet=</span>counter.title))<span class="sc">+</span></span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>    day.of.the.month, accident.i,</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">key=</span><span class="fu">paste</span>(date.str, accident.i),</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip=</span><span class="fu">paste</span>(</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(deaths<span class="sc">==</span><span class="dv">0</span>, <span class="st">""</span>,</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(deaths<span class="sc">==</span><span class="dv">1</span>,</span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>             <span class="st">"1 death,"</span>,</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>             <span class="fu">paste</span>(deaths, <span class="st">"deaths,"</span>))),</span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(people.severely.injured<span class="sc">==</span><span class="dv">0</span>, <span class="st">""</span>,</span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(people.severely.injured<span class="sc">==</span><span class="dv">1</span>,</span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>             <span class="st">"1 person severely injured,"</span>,</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>             <span class="fu">paste</span>(people.severely.injured,</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"people severely injured,"</span>))),</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>      people.slightly.injured,</span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>      <span class="st">"people slightly injured at"</span>,</span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">is.na</span>(street.number), <span class="st">""</span>, street.number),</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>      street, <span class="st">"/"</span>, cross.street,</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>      date.str, time.str),</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill=</span>severity),</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">showSelected=</span><span class="st">"month"</span>,</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="dv">4</span>,</span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">chunk_vars=</span><span class="fu">c</span>(<span class="st">"month"</span>),</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">data=</span><span class="fu">data.table</span>(accidents.cumsum, <span class="at">facet=</span>accidents.title))</span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>DaysFacet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 407 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Ch09-figures/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- paragraph -->
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animint</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  MonthFacet,</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  DaysFacet,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  MonthSummary,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">selector.types=</span><span class="fu">list</span>(<span class="at">severity=</span><span class="st">"multiple"</span>),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">duration=</span><span class="fu">list</span>(<span class="at">month=</span><span class="dv">2000</span>),</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">first=</span><span class="fu">list</span>(</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">location=</span><span class="st">"Berri"</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">month=</span><span class="st">"September 2012"</span>),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">time=</span><span class="fu">list</span>(<span class="at">variable=</span><span class="st">"month"</span>, <span class="at">ms=</span><span class="dv">5000</span>))<span class="co">#buggy.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p></p>
<div id="Ch09vizmtl"></div>
<script>var Ch09vizmtl = new animint("#Ch09vizmtl", "Ch09vizmtl/plot.json");</script>
</div>
</div>
<!-- paragraph -->
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Chapter summary and exercises</h2>
<!-- paragraph -->
<p>Exercises:</p>
<!-- paragraph -->
<ul>
<li>Change location to a multiple selection variable. <!-- comment --></li>
<li>Add a plot for the map to the data viz. <!-- comment --></li>
<li>On the map, draw a circle for each location, with size that changes based on the <code>count</code> of the accidents in the currently selected <code>month</code>. <!-- comment --></li>
<li>On the <code>MonthSummary</code> plot, add a background rectangle that can be used to select the <code>month</code>. <!-- comment --></li>
<li>Remove the <code>MonthSummary</code> plot and add a similar visualization as a third panel in the <code>MonthFacet</code> plot.</li>
</ul>
<!-- paragraph -->
<p>Next, <a href="Ch10-nearest-neighbors.html">Chapter 10</a> explains how to visualize the K-Nearest-Neighbors machine learning model.</p>
<!-- paragraph -->
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>